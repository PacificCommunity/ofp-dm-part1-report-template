---
title: "Annual Part 1 Report to the Western and Central Pacific Fisheries Commission"
author: "`r params$author`"
date: today
date-format: "DD MMMM YYYY"
format: 
  pdf:
    include-in-header: preamble.tex
    tbl-cap-location: bottom
    toc: false
    number-sections: true
    highlight-style: github
    
page-layout: full
edit: visual
params:
  country_code: 'FJ'          # 2-letter country code (all CAPS)
  year: 2024                  # Reporting year (max year of data)
  data_provided: 'Yes'        # Was SciData provided by deadline?
  author: "AUTHOR"
execute: 
  eval: true
  echo: false
  warning: false
  message: false
---

```{r libs}
library(tidyverse)
library(flextable)
library(scales) # Needed for commas in figure axis text
library(maps)
library(sf)

source("utils.R")

# key params
country_cd <- tolower(params$country_code)
report_year = params$year
this_yr_folder = paste0("./data/report_", as.character(report_year), "_", tolower(country_cd), "/") |>
  tolower()

'%nin%' = function(x,y) !x %in% y            

```


```{r header}
row1 <- glue::glue("Scientific data was provided to the Commission in accordance with the decision relating to the provision of scientific data to the Commission by 30 April {params$year+1}: [Yes/No]")
row2 <- "If no, please indicate the reason(s) and intended actions:"
row3 = row4 = row5 = ''

tab <- data.frame(lcol = c(row1, row2, row3, row4, row5), 
                  rcol = c(params$data_provided, rep("", 4)) )

ft <- flextable(tab)
# No header row
ft <- delete_rows(ft, i = 1, part = "header")
# Merge cells - there are a ton of merge_* functions - using this one for simplicity
ft <- merge_at(ft, i = 2:5, j = 1:2)
ft <- valign(ft, i = 2:5, valign = 'top') 
# Relative column width
ft <- width(ft, width = c(1, 0.1)) # Set relative width of columns
ft <- width(ft, width = dim(ft)$widths * 6.6 / (flextable_dim(ft)$widths)) 
ft <- border_outer(ft)
ft <- border_inner(ft)

ft
```


```{r}
#| label: prelims

# Define years to use for tables and figures
yrs_long <- (params$year-4):params$year
yr_range <- paste(min(yrs_long),max(yrs_long), sep="-")

# Map for plotting  
newmap = fortify(maps::map(wrap=c(0,360), plot=FALSE, fill=TRUE))  

# Create a vector of the key species to plot for each gear
ps_species <- c("skj", "yft", "bet", "alb", "pbf")
ll_species <- c("skj", "yft", "bet", "alb", "pbf", "blm", "bum", "mls", "swo")
pl_species <- c("skj", "yft", "bet", "alb", "pbf")

# Define species labels for each gear type
ps_species_labels <- c(
  alb = "ALBACORE",
  bet = "BIGEYE TUNA",
  skj = "SKIPJACK TUNA",
  yft = "YELLOWFIN TUNA"
)

ll_species_labels <- c(
  alb = "ALBACORE",
  bet = "BIGEYE TUNA",
  skj = "SKIPJACK TUNA",
  yft = "YELLOWFIN TUNA",
  pbf = "PACIFIC BLUEFIN TUNA",
  swo = "SWORDFISH",
  blm = "BLACK MARLIN",
  bum = "BLUE MARLIN",
  mls = "STRIPED MARLIN"
)

pl_species_labels <- c(
  alb = "ALBACORE",
  bet = "BIGEYE TUNA",
  skj = "SKIPJACK TUNA",
  yft = "YELLOWFIN TUNA"
)


country_names <- c(
  fj  = "FIJI",
  fm = "FEDERATED STATES OF MICRONESIA",
  gu = "GUAM",
  ki = "KIRIBATI",
  mh = "MARSHALL ISLANDS",
  mp = "NORTHERN MARIANA IS.",
  nc = "NEW CALEDONIA",
  nr = "NAURU",
  nu = "NIUE",
  pf = "FRENCH POLYNESIA",
  pg = "PAPUA NEW GUINEA",
  pn = "PITCAIRN",
  pw = "PALAU",
  sb = "SOLOMON ISLANDS",
  tk = "TOKELAU",
  to = "TONGA",
  tv = "TUVALU",
  vu = "VANUATU",
  wf = "WALLIS AND FUTUNA ISLANDS",
  ws = "SAMOA"
)

# get country name
country_name <- country_names[country_cd] 

  
# Give species colours to maintain colour schemes throughout
# --This makes sure species colors are consistent in all plots

sp_colours <- setNames(object = c("seagreen3","red3","black","cyan1","steelblue","orange",
                                  "pink","wheat","purple3","grey40","dodgerblue4","purple4",
                                  "#66CCFF","salmon4","magenta3","gold"),
                         nm = c("ALBACORE","BIGEYE TUNA","BLACK MARLIN","BLUE MARLIN","BLUE SHARK",
                                "HAMMERHEAD SHARKS NEI","MAKO SHARKS","OCEANIC WHITETIP SHARK",
                                "PACIFIC BLUEFIN TUNA","SILKY SHARK","SKIPJACK TUNA",
                                "STRIPED MARLIN","SWORDFISH","THRESHER SHARKS NEI",
                                "WHALE SHARK","YELLOWFIN TUNA"))
  
```

\newpage

# Abstract / Summary

For inclusion in the SC summary report.

# Background

For example, a brief historical description of national fisheries in the WCPFC Convention Area.

# Flag State Reporting

Describe recent activities by national fleets (by gear type) in the Convention Area, including development/trends in each fishery (e.g. changes in fishing patterns, fleet operations, target species, trends in size composition, etc.).


```{r ps-prep}

# Load all raw data - from t2
data_2953 <- safe_read_and_clean(this_yr_folder, country_cd, r_code = 2953)

data_3063 <- safe_read_and_clean(this_yr_folder, country_cd, r_code = 3063)

data_3153 <- safe_read_and_clean(this_yr_folder, country_cd, r_code = 3153)

data_3155 <- safe_read_and_clean(this_yr_folder, country_cd, r_code = 3155)

data_3040 <- safe_read_and_clean(this_yr_folder, country_cd, r_code = 3040)

data_3168 <- safe_read_and_clean(this_yr_folder, country_cd, r_code = 3168)

data_3605 <- safe_read_and_clean(this_yr_folder, country_cd, r_code = 3605)

# For 3608 with special post-processing
data_3608 <- safe_read_and_clean(
  this_yr_folder, 
  country_cd, 
  r_code = 3608,
  post_process = function(data) {
    data |>
      mutate(
        lon = ifelse(lon < 0, lon + 360, lon),
        lat = ifelse(gear_code == "s", lat + 0.5, lat + 2.5),
        lon = ifelse(gear_code == "s", lon + 0.5, lon + 2.5)
      )
  }
)

# separate in PS, LL and PL
data_3605_ps <- data_3605 |>
  filter(gear_code == "s") |>
  filter(sp_code %in% ps_species) |>
  select(sp_code, year, catch)

data_3605_ll <- data_3605 |>
  filter(gear_code == "l") |>
  filter(sp_code %in% ll_species) |>
  select(sp_code, year, catch)

data_3605_pl <- data_3605 |>
  filter(gear_code == "pl") |>
  filter(sp_code %in% ll_species) |>
  select(sp_code, year, catch)

# shape for tables
if (nrow(data_3605_ps) > 0){
  data_3605_ps_tbl <- data_3605_ps|>
  pivot_wider(names_from = year, values_from = catch) |>
  mutate(across(2:5, ~replace_na(.,0))) |>
  arrange(sp_code) |>
  rename(Species = sp_code) |>
  janitor::adorn_totals("row")
}

if (nrow(data_3605_ll) > 0){
  data_3605_ll_tbl <- data_3605_ll |>
    pivot_wider(names_from = year, values_from = catch) |>
    mutate(across(2:5, ~replace_na(.,0))) |>
    arrange(sp_code) |>
    rename(Species = sp_code) |>
    janitor::adorn_totals("row")
}

if (nrow(data_3605_pl) > 0){
  data_3605_pl_tbl <- data_3605_pl |>
    pivot_wider(names_from = year, values_from = catch) |>
    mutate(across(2:5, ~replace_na(.,0))) |>
    arrange(sp_code) |>
    rename(Species = sp_code) |>
    janitor::adorn_totals("row")
}

```


```{r funcs-render}
#| echo: false

# Function to render gear-specific tables in section 3 with header and table
render_gear_tbl_section3 <- function(data, data_tbl, gear_name, gear_code, species_labels, intro_text = NULL)
  {
  
  # Check if data exists
  if (nrow(data) == 0) {
    return(invisible(NULL))
  }
  
  # Print header
  cat(glue::glue("## Annual catch estimates for the national {gear_name} fleet\n\n"))
  
  # Print intro text if provided (supports markdown)
  if (!is.null(intro_text)) {
    cat(glue::glue(intro_text), "\n\n")
  }
  
  # Create and return the flextable
  ft <- flextable(data_tbl) |>
    labelizor(labels = species_labels, part = "all") |>
    set_table_properties(width = 0.7, align = "center") |> 
    width(j = 1, width = 2)
  return(ft)
}

# Function to render gear-specific figures in section 3 with header and plot
render_gear_figs_section3 <- function(data, gear_name, gear_code, species_list, species_labels, intro_text = NULL) {
  
  # Check if data exists
  if (nrow(data) == 0) {
    return(invisible(NULL))
  }
  
  # Print header
  cat(glue::glue("## Historical annual catch estimates for the national {gear_name} fleet\n\n"))
  
  # Print intro text if provided (supports markdown)
  if (!is.null(intro_text)) {
    cat(glue::glue(intro_text), "\n\n")
  }
  
  # Prepare data for plotting
  data_fig <- data |>
    select(sp_code, year, catch)
  
  ref_df <- expand_grid(year = as.numeric(yrs_long), sp_code = species_list)
  
  plot_data <- left_join(ref_df, data_fig, by = c("year", "sp_code")) |> 
    mutate(across(everything(), ~replace_na(.x, 0))) |>
    # Use species_labels to map sp_code to full names
    mutate(Species = recode(sp_code, !!!species_labels))
  
  # Create and print the plot
  p <- ggplot(plot_data, aes(x = year, y = catch, colour = Species)) + 
    geom_line(linewidth = 1.5) + 
    geom_point(size = 5) +
    scale_colour_manual(values = sp_colours) +
    scale_x_continuous(breaks = seq(min(plot_data$year), max(plot_data$year), 3)) + 
    scale_y_continuous(labels = comma) +
    xlab(element_blank()) + 
    ylab("Catch (mt)") + 
    theme_bw() +
    theme(
      axis.title = element_text(size = 16), 
      axis.text = element_text(size = 16),
      legend.position = "bottom", 
      legend.title = element_blank(),
      legend.text = element_text(size = 13)
    )
  
  print(p)
  
  return(invisible(NULL))
}

# Function to render vessel table for a specific gear
render_vessel_table <- function(ves_data, gear_name, size_categories_fn, intro_text = NULL) {
  
  # Filter for specific gear
  gear_data <- ves_data |> filter(gear_code == gear_name)
  
  # Check if data exists
  if (nrow(gear_data) == 0) {
    return(invisible(NULL))
  }
  
  # Apply the size category function to summarize data
  ves_summary <- gear_data |>
    group_by(year, gear) |> 
    size_categories_fn()
  
  # Check if there's any actual vessel data (not all zeros)
  if (sum(ves_summary[,-c(1:2)]) == 0) {
    return(invisible(NULL))
  }
  
  # Print intro text if provided (supports markdown)
  if (!is.null(intro_text)) {
    cat(glue::glue(intro_text), "\n\n")
  }
  
  # Create and return flextable
  ves_summary |> 
    pivot_longer(-c(year, gear), names_to = "Size Category (GRT)", values_to = "Vessels") |>
    pivot_wider(names_from = year, values_from = Vessels, values_fill = 0) |>
    group_by(gear) |> 
    mutate(gear = ifelse(row_number() == 1, gear, "")) |>
    flextable() |>  
    set_table_properties(width = 0.7, align = "center") |> 
    width(j = 1:2, width = 1.2)
}

# Function to render spatial catch distribution map for a specific gear
render_spatial_map <- function(data, gear_code, gear_name, target_species, year_range, intro_text = NULL) {
  
  gear_code <- tolower(gear_code)
  
  # Filter and prepare data
  spatial_data <- data |>  
    filter(
      between(year, year_range[1], year_range[2]), 
      gear_code == !!gear_code, 
      sp_code %in% target_species
    ) |> 
    group_by(lat, lon, year, species) |> 
    summarise(catch = sum(catch), .groups = "drop") |> 
    filter(catch > 0)
  
  # Check if data exists
  if (nrow(spatial_data) == 0) {
    return(invisible(NULL))
  }
  
  # Print intro text if provided (supports markdown)
  if (!is.null(intro_text)) {
    cat(glue::glue(intro_text), "\n\n")
  }
  
  # Create the map
  p <- ggplot() +
    geom_map(data = newmap, map = newmap, aes(map_id = region), fill = 'bisque1', col = 'gray') +
    geom_tile(data = spatial_data, aes(lon, lat, fill = catch)) +
    scale_fill_distiller(palette = "Spectral") +
    scale_x_continuous(limits = c(120, 230), expand = c(0, 0), breaks = seq(140, 220, 40)) +
    scale_y_continuous(limits = c(-35, 25), expand = c(0, 0)) +
    facet_grid(year ~ species) +
    xlab("Longitude") + ylab("Latitude") + labs(fill = "Catch (mt)") +
    theme_bw() +
    theme(
      axis.text = element_text(size = 18),
      legend.text = element_text(size = 18),
      legend.title = element_text(size = 18),
      strip.background = element_rect(fill = 'white'),
      strip.text = element_text(size = 18),
      axis.title = element_text(size = 20), 
      title = element_text(size = 20)
    ) +
    coord_sf() +
    ggtitle(glue::glue('Spatial patterns in catch for the {gear_name} fishery'))
  
  print(p)
  return(invisible(NULL))
}

# Function to render SSI (Species of Special Interest) table for a specific gear
render_ssi_table <- function(data, gear_code, gear_name, intro_text = NULL) {
  
  # Filter data for specific gear
  tab_data <- data |>  
    filter(gear == gear_code) |> 
    select(-gear) |>
    arrange(year)
  
  # Check if data exists
  if (nrow(tab_data) == 0) {
    return(invisible(NULL))
  }
  
   # Print header
  cat(glue::glue("### Observed catches of SSIs by the {gear_name} fleet\n\n"))
  
  # Print intro text if provided (supports markdown)
  if (!is.null(intro_text)) {
    cat(glue::glue(intro_text), "\n\n")
  }

  # Create and return flextable
  flextable(tab_data) |>
    set_table_properties(layout = "autofit", width = 0.95, align = "center") |> 
    fontsize(size = 9, part = "all") |> 
    colformat_num(j = "year", big.mark = "") |>  
    width(j = c("category", "species"), width = 1.5) |> 
    align(align = "center", part = "all") |> 
    labelizor(
      labels = c(
        year = "Year",
        species = "Species",
        category = "Category",
        number = "Total",
        alive = "Alive",  # Fixed capitalization
        dead = "Dead"
      ), 
      part = "all"
    ) |>
    padding(padding.left = 5, padding.right = 5, part = "all")
}

```  


```{r}
#| echo: false
#| results: 'asis'
#| label: tbl-tbl1s
#| tbl-cap: !expr if(nrow(data_3605_ps) > 0) glue::glue("Annual catch estimates for the {country_name} purse seine fleet, by primary species and year, in the WCPFC Convention Area") else ""

render_gear_tbl_section3(
  data = data_3605_ps,
  data_tbl = data_3605_ps_tbl,
  gear_name = "purse seine",
  gear_code = "s",
  species_labels = ps_species_labels,
  intro_text = "The annual catches of the **primary species** caught by the {country_name} purse seine fleet are shown in @tbl-tbl1s.
  
  *Note:* This includes all catches in the WCPFC Convention Area."
)
```

```{r}
#| echo: false
#| results: 'asis'
#| label: tbl-tbl1l
#| tbl-cap: !expr if(nrow(data_3605_ll) > 0) glue::glue("Annual catch estimates for the {country_name} longline fleet, by primary species and year, in the WCPFC Convention Area over {yr_range}") else ""

render_gear_tbl_section3(
  data = data_3605_ll,
  data_tbl = data_3605_ll_tbl,
  gear_name = "longline",
  gear_code = "l",
  species_labels = ll_species_labels,
  intro_text = "The longline fleet primarily targets **tunas** and **billfish** species."
)
```

```{r}
#| echo: false
#| results: 'asis'
#| label: tbl-tbl1pl
#| tbl-cap: !expr if(nrow(data_3605_pl) > 0) glue::glue("Annual catch estimates for the {country_name} pole line fleet, by primary species and year, in the WCPFC Convention Area over {yr_range}") else ""

render_gear_tbl_section3(
  data = data_3605_pl,
  data_tbl = data_3605_pl_tbl,
  gear_name = "pole line",
  gear_code = "pl",
  species_labels = ll_species_labels,
  intro_text = "The poleline fleet primarily targets **tunas** and **billfish** species."
)
```

\newpage
```{r}
#| echo: false
#| results: 'asis'
#| fig-pos: 'H'
#| label: fig-fig1l
#| fig-cap: !expr if(nrow(data_3605_ll) > 0) glue::glue("Historical annual catch estimates for the {country_name} longline fleet, by primary species and year, in the WCPFC Convention Area") else ""
#| fig-width: 12
#| fig-height: 7
#| fig-align: "center"

render_gear_figs_section3(
  data = data_3605_ll,
  gear_name = "longline",
  gear_code = "l",
  species_list = ll_species,
  species_labels = ll_species_labels,
  intro_text = "The annual catches show a clear trend over time."
)
```

\newpage

```{r}
#| echo: false
#| results: 'asis'
#| fig-pos: 'H'
#| label: fig-fig1s
#| fig-cap: !expr if(nrow(data_3605_ps) > 0) glue::glue("Historical annual catch estimates for the {country_name} purse seine fleet, by primary species and year, in the WCPFC Convention Area") else ""
#| fig-width: 12
#| fig-height: 7
#| fig-align: "center"

render_gear_figs_section3(
  data = data_3605_ps,
  gear_name = "purse seine",
  gear_code = "s",
  species_list = ps_species,
  species_labels = ps_species_labels,
  intro_text = "The annual catches show a clear trend over time."
)
```

\newpage

```{r}
#| echo: false
#| results: 'asis'
#| fig-pos: 'H'
#| label: fig-fig1pl
#| fig-cap: !expr if(nrow(data_3605_pl) > 0) glue::glue("Historical annual catch estimates for the {country_name} pole line fleet, by primary species and year, in the WCPFC Convention Area") else ""
#| fig-width: 12
#| fig-height: 7
#| fig-align: "center"

render_gear_figs_section3(
  data = data_3605_pl,
  gear_name = "pole line",
  gear_code = "pl",
  species_list = pl_species,
  species_labels = pl_species_labels,
  intro_text = "The annual catches show a clear trend over time."
)
```

\newpage
## Historical annual vessel numbers for the national fleet

```{r}
#| label: fig-fig2
#| fig-pos: 'H'
#| fig-cap: !expr if(nrow(data_3605) > 0) glue::glue("Historical annual vessel numbers for the {country_name} fleet, by gear, for the WCPFC Convention Area") else ""
#| fig-width: 12
#| fig-height: 7
#| fig-align: "center"

if (nrow(data_3605) > 0){
  # Plot of vessel numbers for only Longline, Purse seine and Pole Line, aggregated over size class
ves_calcs <- 
  data_3605 |>  
  filter(year %in% yrs_long, gear_code %in% c("s", "l", "pl")) |>  # âœ… Include only LL and PS
  select(flag, year, gear_code, vessels_sml, vessels_med, vessels_lge, vessels_hge) |> 
  distinct() |> 
  mutate(Vessels = rowSums(across(starts_with("vessels_")), na.rm = TRUE)) |> 
  group_by(year, gear_code) |> 
  summarise(Vessels = sum(Vessels), .groups = "drop") |>
  mutate(gear = case_when(gear_code  == "s" ~ "Purse seine",
                               gear_code == "l" ~ "Longline",
                          gear_code == "pl" ~ "Pole line"))

ggplot(ves_calcs, aes(x = year, y = Vessels, colour = gear)) +
  geom_line(linewidth = 1.5) + 
  geom_point(size = 5) + 
  theme_bw() +
  scale_colour_manual(values = c("Purse seine" = "lightblue", "Longline" = "steelblue", 
                                 "Pole line" = "#23415a")) +
  scale_x_continuous(breaks = seq(min(ves_calcs$year), max(ves_calcs$year), 3)) +
  xlab(NULL) + ylab("Number of vessels in fleet") +
  theme(
    axis.title = element_text(size = 16), 
    axis.text = element_text(size = 16),
    legend.position = "bottom", 
    legend.title = element_blank(),
    legend.text = element_text(size = 13)
  )
  }else{
    cat(paste0("No fishing was reported in ",report_year,", nor was any catch reported."))
    }


```

\newpage
## Number of active vessels by gear and size category over recent years

```{r}

#| echo: false

# Prepare vessel data once
if(nrow(data_3605) > 0){
  ves_raw <- 
    data_3605 |>  
    filter(year %in% yrs_long, gear_code %in% c("s", "l", "pl")) |> 
    select(flag, year, gear_code, vessels_sml, vessels_med, vessels_lge, vessels_hge) |> 
    distinct() |>
    mutate(gear = case_when(
      gear_code == "s" ~ "Purse seine",
      gear_code == "l" ~ "Longline",
      gear_code == "pl" ~ "Pole line"
    ))
} else {
  ves_raw <- tibble()
}

# Define size category functions for each gear type
ll_size_fn <- function(data) {
  data |>
  summarise(
    '0 - 50' = sum(vessels_sml),
    '51 - 200' = sum(vessels_med),
    '201 - 500' = sum(vessels_lge),
    '500+' = sum(vessels_hge),
    .groups = "drop"
  )
}

ps_size_fn <- function(data) {
  data |>
  summarise(
    '0 - 50' = sum(vessels_sml),
    '51 - 200' = sum(vessels_med),
    '201 - 500' = sum(vessels_lge),
    '500+' = sum(vessels_hge),
    .groups = "drop"
  )
}

pl_size_fn <- function(data) {
  data |>
  summarise(
    '0 - 50' = sum(vessels_sml),
    '51 - 150' = sum(vessels_med),
    '150+' = sum(vessels_lge + vessels_hge),
    .groups = "drop"
  )
}

```

```{r}
#| label: tbl-tbl2-longline
#| tbl-cap: !expr if(nrow(ves_raw |> filter(gear_code == "l")) > 0) glue::glue("Number of {country_name} longline vessels, by size category, active in the WCPFC Convention Area, over {yr_range}") else ""
#| echo: false
#| results: 'asis'

render_vessel_table(
  ves_data = ves_raw,
  gear_name = "l",
  size_categories_fn = ll_size_fn,
  intro_text = "Some text"
)
```

```{r}
#| label: tbl-tbl2-ps
#| tbl-cap: !expr  if(nrow(ves_raw |> filter(gear_code == "s")) > 0) glue::glue("Number of {country_name} purse seine vessels, by size category, active in the WCPFC Convention Area, over {yr_range}") else ""
#| echo: false
#| results: 'asis'

render_vessel_table(
  ves_data = ves_raw,
  gear_name = "s",
  size_categories = ps_size_fn,
  intro_text = "Some text"

)
```

```{r}
#| label: tbl-tbl2-pl
#| tbl-cap: !expr  if(nrow(ves_raw |> filter(gear_code == "pl")) > 0) glue::glue("Number of {country_name} pole-and-line vessels, by size category, active in the WCPFC Convention Area, over {yr_range}") else ""
#| echo: false
#| results: 'asis'

render_vessel_table(
  ves_data = ves_raw,
  gear_name = "pl",
  size_categories = pl_size_fn,
  intro_text = "Some text"
)
```


\newpage
## Distribution of catches of target species for different national fisheries



```{r}
#| label: fig-figmapps
#| fig-cap: !expr  if(nrow(data_3608 |> filter(gear_code == "s") > 0)) glue::glue("Map showing the distribution of target species catch (mt) for the {country_name} purse seine fishery.") else ""
#| fig-width: 13
#| fig-height: 13
#| fig-align: "center"
#| fig-pos: "H"
#| echo: false
#| message: false
#| warning: false

# explain that this is BEST data, how it is calculated, how it differs from ACE and how often it gets updated.

render_spatial_map(
  data = data_3608,
  gear_code = "s",
  gear_name = "purse seine",
  target_species = c("bet","skj","yft"),
  year_range = c(params$year - 4, params$year),
  intro_text = "Some text"

)
```

```{r}
#| label: fig-figmapl
#| fig-cap: !expr if(nrow(data_3608 |> filter(gear_code == "l") > 0)) glue::glue("Map showing the distribution of target species catch (mt) for the {country_name} longline fishery.") else ""
#| fig-width: 13
#| fig-height: 13
#| fig-align: "center"
#| fig-pos: "H"
#| echo: false
#| message: false
#| warning: false

render_spatial_map(
  data = data_3608,
  gear_code = "l",
  gear_name = "longline",
  target_species = c("bet","alb","yft"),
  year_range = c(params$year - 4, params$year),
  intro_text = "Some text"

)
```

```{r}
#| label: fig-figmappl
#| fig-cap: !expr if(nrow(data_3608 |> filter(gear_code == "pl") > 0)) glue::glue("Map showing the distribution of target species catch (mt) for the {country_name} pole line fishery.") else ""
#| fig-width: 13
#| fig-height: 13
#| fig-align: "center"
#| fig-pos: "H"
#| echo: false
#| message: false
#| warning: false

render_spatial_map(
  data = data_3608,
  gear_code = "pl",
  gear_name = "pole line",
  target_species = c("skj", "yft", "bet"),
  year_range = c(params$year - 4, params$year),
  intro_text = "Some text"

)
```


\newpage
## Captures of species of special interest (SSIs)
Note that the tables below are specified to include - seabird, turtle and marine mammals in the instructions but we also include things like some rays and sharks. Note that Alive plus Dead does not necessarily equal Total due to unknowns. PW has no SSI captures and TK and NU have no flagged fleets.

```{r}
#| label: tbl-tbl3s
#| tbl-cap: !expr if(nrow(data_2953 |> filter(gear == "s") > 0)) glue::glue("Observed annual estimated catches of species of special interest (seabird, turtle and marine mammals) by the {country_name} purse seine fleet, in the WCPFC Convention Area, for years {yr_range}, to the extent possible. Note that the Total may not reflect the sum of Alive and Dead as some animals are reported with an Unknown status.") else ""
#| echo: false
#| results: 'asis'

render_ssi_table(
  data = data_2953,
  gear_code = "s",
  gear_name = "purse seine",
  intro_text = "Some text"

)
```

```{r}
#| label: tbl-tbl3ll
#| tbl-cap: !expr if(nrow(data_2953 |> filter(gear == "l") > 0)) glue::glue("Observed annual estimated catches of species of special interest (seabird, turtle and marine mammals) by the {country_name} longline fleet, in the WCPFC Convention Area, for years {yr_range}") else ""
#| echo: false
#| results: 'asis'

render_ssi_table(
  data = data_2953,
  gear_code = "l",
  gear_name = "longline",
  intro_text = "Some text"

)
```

```{r}
#| label: tbl-tbl3lpl
#| tbl-cap: !expr if(nrow(data_2953 |> filter(gear == "pl") > 0)) glue::glue("Observed annual estimated catches of species of special interest (seabird, turtle and marine mammals) by the {country_name} pole line fleet, in the WCPFC Convention Area, for years {yr_range}") else ""
#| echo: false
#| results: 'asis'

render_ssi_table(
  data = data_2953,
  gear_code = "pl",
  gear_name = "pole line",
  intro_text = "Some text"

)
```

```{r}
# Create non-target purse seine table
# Create table of non-target species for purse seine
PS_tab <- 
  data_3605 |>  
  filter(gear_code == "s", 
         year %in% yrs_long,
         !sp_code %in% ps_species) |>  # Exclude only the key species
  group_by(sp_code, year) |> 
  summarise(catch = sum(catch, na.rm = TRUE), .groups = "drop") |> 
  pivot_wider(names_from = year, values_from = catch, values_fill = 0) |> 
  arrange(sp_code)

#todo: present species name instead of codes
```

```{r}
#| label: tbl-tbl4s
#| tbl-cap: !expr glue::glue("Annual estimated catches of non-target, associated and dependent species, including sharks, by the {country_name} purse seine fleet, in the WCPFC Convention Area over {yr_range}")
#| echo: false
#| results: 'asis'

# Ensure required columns are present even when empty
required_cols <- c("sp_code", as.character((params$year - 4):params$year))
if (nrow(PS_tab) > 0) {
  # Print header
  cat(glue::glue("## Annual catch estimates for non-target, associated and dependent species for the national purse seine fleet\n\n"))
  
  flextable(PS_tab) |>  
    set_table_properties(layout = "autofit", width = 0.95, align = "center") |> 
    fontsize(size = 9, part = "all") |> 
    width(j = 1, width = 2) |> 
    colformat_num(big.mark = ",") |> 
    align(align = "center", part = "all") |> 
    padding(padding.left = 5, padding.right = 5, part = "all")
}
```

```{r}
# Create table of non-target species for longline
LL_tab <- 
  data_3605 |>  
  filter(gear_code == "l", 
         year %in% yrs_long,
         !sp_code %in% ps_species) |>  # Exclude only the key species
  group_by(sp_code, year) |> 
  summarise(catch = sum(catch, na.rm = TRUE), .groups = "drop") |> 
  pivot_wider(names_from = year, values_from = catch, values_fill = 0) |> 
  arrange(sp_code)
```

```{r}
#| label: tbl-tbl4l
#| tbl-cap: !expr glue::glue("Annual estimated catches of non-target, associated and dependent species, including sharks, by the {country_name} longline fleet, in the WCPFC Convention Area over {yr_range}")
#| echo: false
#| results: 'asis'

# Ensure LL_tab has all expected columns even if empty
required_cols <- c("sp_code", as.character((params$year - 4):params$year))
if (nrow(LL_tab) > 0) {
  # Print header
  cat(glue::glue("## Annual catch estimates for non-target, associated and dependent species for the national longline fleet\n\n"))
  
  flextable(LL_tab) |>  
    set_table_properties(layout = "autofit", width = 0.95, align = "center") |> 
    fontsize(size = 9, part = "all") |> 
    width(j = 1, width = 2) |> 
    colformat_num(big.mark = ",") |> 
    align(align = "center", part = "all") |> 
    padding(padding.left = 5, padding.right = 5, part = "all")
}
```

\newpage
# Coastal State Reporting

Describe recent activities by foreign and domestic fleets in the waters of national jurisdiction, including development/trends in each fishery (e.g. changes in fishing patterns, fleet operations, target species, trends in size composition, etc.).

# Socio-economic factors

Associated socioeconomic factors (which may influence or explain the above trends).

# Disposal of catch

Disposal of catch (fresh/frozen/other) / market destination (export/domestic).

<!-- ```{r} -->
<!-- #| label: tbl-tbldis -->
<!-- #| tbl-cap: !expr glue::glue("Summary of the disposal of catches in {country_name} ports from the fishing fleets (purse seine, longline, pole and line) operating in {country_name} in {params$year}") -->

<!-- dis_dat <- read.csv("data/catch_disposals.csv") -->

<!-- flextable(dis_dat) |>  -->
<!--   set_table_properties(layout = "fixed", width = 0.95) |>  -->
<!--   fontsize(size = 5, part = "all") |>  -->
<!--   set_header_labels(values =    -->
<!--                       c("Activities",rep(c("PS","LL","PL"),time=2),rep(c("PS","LL"),time=5)) ) |>  -->
<!--     add_header_row(values =  -->
<!--                      c("","Skipjack(mt)","Yellowfin(mt)","Bigeye(mt)", -->
<!--                        "Albacore(mt)","Billfish(mt)","Sharks(mt)","Other(mt)"), -->
<!--                    colwidths = c(1,3,3,2,2,2,2,2)) |>  -->
<!--     #width(width = .5) |>   -->
<!--     width(j = 2:17, width = .33) |>  -->
<!--     align(align = "center", part = "header") -->

<!-- ``` -->

# Onshore developments

Onshore developments (processing plants, support facilities etc.).

# Future prospects of the fishery

Future prospects of the fishery (long-term viability, expansion/contraction, etc.).

# Status of tuna fishery data collection systems

a.  Logsheet data collection and verification

b.  Observer programme

c.  Port sampling programme

d.  Unloading/Transhipment

e.  Other

# Research activities covering target and non-target species

For example, biological studies supporting stock assessments; composition of the catch according to length, weight and sex; research on environmental factors, abundance/biomass surveys, oceanographic and ecological studies, etc.


