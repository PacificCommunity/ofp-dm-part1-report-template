---
title: "Generate Artisanal ACE"
author: "SPC - for CK"
format: 
  html:
    page-layout: full
editor: visual
toc: true
toc-location: left
toccolor: blue
urlcolor: blue
embed-resources: true 
execute: 
  echo: false
  message: false
  warning: false
params:
  flag: 'VU'
  year: 2024
---

```{r}
# Load necessary libraries
library(DBI)
library(odbc)
library(tidyverse)
library(flextable)
#library(DT)


# Define the year
year <- params$year

    # Create a connection string (generic connection, no database specified)
    connection_string <- "Driver={SQL Server};Server=noufamesql01;Database=tufman2"
    # Establish the database connection
    con <- dbConnect(odbc::odbc(), .connection_string = connection_string)


'%nin%' = function(x,y) !x %in% y            

```

::: panel-tabset
## Methodology

The steps for preparing the artisanal catch estimates for key tuna species are outlined below, with the following tabs showing the catch and effort estimates that are used to prepare the final catch estimates. It should be noted that the Tails (and moving forward, Ikasavea) app captures a sample of the artisanal fishing activity. At this point, we do not have comprehensive surveys in place to scale up those estimates in a reliable and representative manner. Therefore, we are basing these estimates on a combination of reporting catch and effort as well as local expert knowledge of the activities at different landing sites.

In the future, we hope to progress the Frame Survey concept to being to refine the estimates of total effort that are used to scale up the sampled catch estimates reported in the respective applications.

1.  We provide a summary of number of trips by month and landing site from the TAILS trip and activity logs
2.  We compare to "rough" estimates of average monthly landings (trips) per month and landing site \[used if activity log data is unreliable/incomplete\]
3.  The tuna catch by landings site and month is calculated
4.  We then multiply the monthly CPUE (catch/trip) by the estimated number of trips, and if those data are missing, we use an average CPUE multiplied by the number of trips
5.  The artisanal ACE is the sum across all months and landing sites

Please also note that until this point, Iksavea and Tails are separate applications collecting data in separate places. Therefore, please review the Iksavea data (SPC can provide) and the T2 report (#3095) for other species that may be have been reported to supplement this assessment of key tuna catches.

## Fishing Effort

### Data prep: Effort

Below is a summary of the number of reported **trips** in `r params$year` by month and landing site, as reported in Tails. This table compares both fishing days and trips reported (using the number of motor and paddle vessel trips reported), and takes the maximum value as an estimate of trips.

<details>

<summary>Reported Trips</summary>

```{r}
# Report 1

tab1 <- 
  dbGetQuery(con, 
  paste0(
        "SELECT x.landing_site_name, x.entity, 
      		max(x.jan_trips) as jan_trips,
      		max(x.feb_trips) as feb_trips,
      		max(x.mar_trips) as mar_trips,
      		max(x.apr_trips) as apr_trips,
      		max(x.may_trips) as may_trips,
      		max(x.jun_trips) as jun_trips,
      		max(x.jul_trips) as jul_trips,
      		max(x.aug_trips) as aug_trips,
      		max(x.sep_trips) as sep_trips,
      		max(x.oct_trips) as oct_trips,
      		max(x.nov_trips) as nov_trips,
      		max(x.dec_trips) as dec_trips
      FROM 
      (
      SELECT landing_site_name, ref.GetEntityfromBit(instance_source) as entity,
      		sum(case when MONTH(activity_date) = 1 then coalesce(motor_vessels_n,0)+coalesce(paddle_vessels_n,0) else 0 end) as jan_trips,
      		sum(case when MONTH(activity_date) = 2 then coalesce(motor_vessels_n,0)+coalesce(paddle_vessels_n,0) else 0 end) as feb_trips,
      		sum(case when MONTH(activity_date) = 3 then coalesce(motor_vessels_n,0)+coalesce(paddle_vessels_n,0) else 0 end) as mar_trips,
      		sum(case when MONTH(activity_date) = 4 then coalesce(motor_vessels_n,0)+coalesce(paddle_vessels_n,0) else 0 end) as apr_trips,
      		sum(case when MONTH(activity_date) = 5 then coalesce(motor_vessels_n,0)+coalesce(paddle_vessels_n,0) else 0 end) as may_trips,
      		sum(case when MONTH(activity_date) = 6 then coalesce(motor_vessels_n,0)+coalesce(paddle_vessels_n,0) else 0 end) as jun_trips,
      		sum(case when MONTH(activity_date) = 7 then coalesce(motor_vessels_n,0)+coalesce(paddle_vessels_n,0) else 0 end) as jul_trips,
      		sum(case when MONTH(activity_date) = 8 then coalesce(motor_vessels_n,0)+coalesce(paddle_vessels_n,0) else 0 end) as aug_trips,
      		sum(case when MONTH(activity_date) = 9 then coalesce(motor_vessels_n,0)+coalesce(paddle_vessels_n,0) else 0 end) as sep_trips,
      		sum(case when MONTH(activity_date) = 10 then coalesce(motor_vessels_n,0)+coalesce(paddle_vessels_n,0) else 0 end) as oct_trips,
      		sum(case when MONTH(activity_date) = 11 then coalesce(motor_vessels_n,0)+coalesce(paddle_vessels_n,0) else 0 end) as nov_trips,
      		sum(case when MONTH(activity_date) = 12 then coalesce(motor_vessels_n,0)+coalesce(paddle_vessels_n,0) else 0 end) as dec_trips
        
        FROM [art2].[fishing_activity_log] a1 
      		inner join [art2].[landing_sites] a2 on a1.landing_site_id = a2.landing_site_id
            where YEAR(activity_date) = ",year,"
          group by  landing_site_name, ref.GetEntityfromBit(instance_source)
          union
          SELECT landing_site_name, ref.GetEntityfromBit(instance_source) as entity,
      		count(distinct case when MONTH(trip_date) = 1 then a1.art_trip_id else null end) as jan_trips,
      		count(distinct case when MONTH(trip_date) = 2 then a1.art_trip_id else null end) as feb_trips,
      		count(distinct case when MONTH(trip_date) = 3 then a1.art_trip_id else null end) as mar_trips,
      		count(distinct case when MONTH(trip_date) = 4 then a1.art_trip_id else null end) as apr_trips,
      		count(distinct case when MONTH(trip_date) = 5 then a1.art_trip_id else null end) as may_trips,
      		count(distinct case when MONTH(trip_date) = 6 then a1.art_trip_id else null end) as jun_trips,
      		count(distinct case when MONTH(trip_date) = 7 then a1.art_trip_id else null end) as jul_trips,
      		count(distinct case when MONTH(trip_date) = 8 then a1.art_trip_id else null end) as aug_trips,
      		count(distinct case when MONTH(trip_date) = 9 then a1.art_trip_id else null end) as sep_trips,
      		count(distinct case when MONTH(trip_date) = 10 then a1.art_trip_id else null end) as oct_trips,
      		count(distinct case when MONTH(trip_date) = 11 then a1.art_trip_id else null end) as nov_trips,
      		count(distinct case when MONTH(trip_date) = 12 then a1.art_trip_id else null end) as dec_trips
        FROM [art2].[trips] a1 inner join [art2].[landing_sites] a2 on a1.landing_site_id = a2.landing_site_id
          where YEAR(trip_date) = ",year,"
         group by landing_site_name, ref.GetEntityfromBit(instance_source) ) x
         group by x.landing_site_name, x.entity ") )

tab1 <- tab1 |> filter(entity==params$flag) |> select(-entity)

```

```{r}
#| label: Monthly-effort
#| tbl-cap: Number of trips per month and landing site reported in Tails

flextable( tab1 ) |>  
  width(j=1, width=1.2) |> 
  fontsize(size = 10, part = "all")

```

</details>

Read in member-estimated **trips** per month at each landing site. Some landing sites may not have any activity, that is OK. The member-provided estimates of effort by landing site and compared with the Tails reported effort to produce a 'best' estimate of effort.

<details>

<summary>Local Knowledge - Trips</summary>

```{r trips-est-mem}
#| label: mem-trips
#| tbl-cap: Member reported estimated trips per month per landing site


est.trips = read.csv(paste0('Estimated_trip_site_',params$flag,'_updated.csv')) |> 
  filter(!is.na(est.trips))

flextable(est.trips)  |>  fontsize(size = 10, part = "all") |> width(j=1, width=2)

```

</details>

Below is a summary of the number of reported **days** in `r params$year` by month and landing site, as reported in Tails. This is used to estimate the number of trips per day.

<details>

<summary>Reported Days</summary>

```{r}
# Report 3

tab2 <- 
  dbGetQuery(con, 
  paste0(
      "SELECT landing_site_name, ref.GetEntityfromBit(instance_source) as entity,
      		count(distinct case when MONTH(trip_date) = 1 then a1.art_trip_id else null end) as jan_days,
      		count(distinct case when MONTH(trip_date) = 2 then a1.art_trip_id else null end) as feb_days,
      		count(distinct case when MONTH(trip_date) = 3 then a1.art_trip_id else null end) as mar_days,
      		count(distinct case when MONTH(trip_date) = 4 then a1.art_trip_id else null end) as apr_days,
      		count(distinct case when MONTH(trip_date) = 5 then a1.art_trip_id else null end) as may_days,
      		count(distinct case when MONTH(trip_date) = 6 then a1.art_trip_id else null end) as jun_days,
      		count(distinct case when MONTH(trip_date) = 7 then a1.art_trip_id else null end) as jul_days,
      		count(distinct case when MONTH(trip_date) = 8 then a1.art_trip_id else null end) as aug_days,
      		count(distinct case when MONTH(trip_date) = 9 then a1.art_trip_id else null end) as sep_days,
      		count(distinct case when MONTH(trip_date) = 10 then a1.art_trip_id else null end) as oct_days,
      		count(distinct case when MONTH(trip_date) = 11 then a1.art_trip_id else null end) as nov_days,
      		count(distinct case when MONTH(trip_date) = 12 then a1.art_trip_id else null end) as dec_days
        FROM [art2].[trips] a1 inner join [art2].[landing_sites] a2 on a1.landing_site_id = a2.landing_site_id
        where YEAR(trip_date) = ",year,"
      group by  landing_site_name, ref.GetEntityfromBit(instance_source) ") )

tab2 <- tab2 |> filter(entity==params$flag) |> select(-entity)
```

```{r}
#| label: tab2
#| tbl-cap: Estimated fishing days reported in Tails

flextable(tab2 ) |>  fontsize(size = 10, part = "all")

```

</details>

### Best estimate of fishing trips

Now estimate monthly trips, based on the max value either reported by the member or reported in Tails.

```{r max.trips}
#| label: est-trips-monthly
#| tbl-cap: Best estimate of trips per month at each landing site

# Formerly Table 8 in old Excel
tab8 = tab1 |> full_join(est.trips) 
tab8[is.na(tab8)] <- 0

for( i in 2:13){
  tab8[ ,i] = ifelse( tab8[ ,i] >  tab8[ ,14] ,  tab8[ ,i] , tab8[ ,14] ) 
}

# Get rid of sites that only have NAs
tab8$num_na_cols <- rowSums(tab8[, 2:13] )

tab8 <- tab8 |>  filter(num_na_cols>0) |> 
  select(-c(est.trips, num_na_cols))

# Now check for site with days but no trips -- just in case
tab8 <- tab8 |> rbind(tab2 |>  filter(landing_site_name %nin% tab8$landing_site_name))

flextable(tab8)  |>  fontsize(size = 8, part = "all")

```

<!-- ### Step 1: Calculate trip/day -->

<!-- This step is ONLY useful if the ACTIVIY LOG is complete. -->

<!-- ```{r trips-day} -->

<!-- trips.day = tab1 |> gather(key='mon', value='trips', -c(1:2)) |> mutate(mon=substr(mon,1,3)) |>  -->

<!--   left_join(tab2 |> gather(key='mon', value='days', -1) |> mutate(mon=substr(mon,1,3))  ) |>  -->

<!--   mutate(trip.day = trips/days, trip.day = ifelse(is.na(trip.day),1,trip.day)) -->

<!-- ``` -->

## Catch Estimates

### Data prep: Catch

**Unraised** tuna catches reported in Tails are illustrated below, in kilograms (kgs).

<details>

<summary>Skipjack: SKJ</summary>

```{r}
# Report 4
unr.catch <-  
  dbGetQuery(con, 
  paste0(
      "SELECT landing_site_name, ref.GetEntityfromBit(instance_source) as entity,
          MONTH(trip_date) as month, sp_code, sp_kg
      FROM art2.trips a1 
        inner join art2.landing_sites a2 on a1.landing_site_id = a2.landing_site_id
      	inner join art2.effort e on a1.art_trip_id = e.art_trip_id
      	left outer join art2.catch c on e.art_effort_id = c.art_effort_id  
      	where sp_code in ('SKJ', 'YFT', 'BET')
        and YEAR(trip_date) = ",year) )
      
unr.catch <-  unr.catch |> filter(entity==params$flag) |> select(-entity)  |> 
  group_by(landing_site_name, month, sp_code) |> 
  summarise(sp_kg = sum(sp_kg, na.rm=T)) |> 
  arrange(month) |> 
  pivot_wider(names_from = month, values_from = sp_kg, values_fill=0)

missing.mon <- as.character( setdiff(1:12, names(unr.catch)) )  # Find names of missing columns
unr.catch[,missing.mon] <- 0 

unr.catch <- unr.catch |>  select(landing_site_name, sp_code, as.character(1:12) )

names(unr.catch)[3:14]  <- c('jan', 'feb','mar','apr','may','jun',
                             'jul','aug','sep','oct','nov','dec')
      

# Calculate total effort by landing site
tab2$tot_trips =  rowSums(tab2[,-1],na.rm=T)
tot.trips = tab2 |>  select(landing_site_name, tot_trips)

unr.skj <- unr.catch |>  filter(sp_code=='SKJ') |> select(-sp_code)

# Now calculate monthly average catch per trip (using tab2)
avg.skj = data.frame(landing_site_name = unr.skj$landing_site_name, 
                tot_catch = rowSums(unr.skj[,-1],na.rm=T)  ) |> 
              left_join(tot.trips) |> 
  mutate(skj.cpd = round(tot_catch/tot_trips,0) )

unr.skj <- unr.skj |> left_join(avg.skj |> select(landing_site_name, skj.cpd))

```

```{r}
#| label: unr.skj
#| tbl-cap: Unraised skipjack catch (kgs) reported in Tails

flextable(unr.skj) |>  fontsize(size = 10, part = "all")

```

</details>

<details>

<summary>Yellowfin: YFT</summary>

```{r}
# Unraised YFT catch

unr.yft <- unr.catch |>  filter(sp_code=='YFT') |> select(-sp_code)
# Now calculate monthly average catch per trip (using tab2)
avg.yft = data.frame(landing_site_name = unr.yft$landing_site_name, 
                tot_catch = rowSums(unr.yft[,-1],na.rm=T)  ) |> 
              left_join(tot.trips) |> 
  mutate(yft.cpd = round(tot_catch/tot_trips,0) )

unr.yft <- unr.yft |> left_join(avg.yft |> select(landing_site_name, yft.cpd))
```

Unraised yellowfin catch (kgs) reported in Tails:

```{r unr.yft}
flextable(unr.yft) |>  fontsize(size = 10, part = "all")

```

</details>

<details>

<summary>Bigeye: BET</summary>

```{r}
# Report 6

unr.bet <- unr.catch |>  filter(sp_code=='BET') |> select(-sp_code)

# Now calculate monthly average catch per trip (using tab2)
avg.bet = data.frame(landing_site_name = unr.bet$landing_site_name, 
                tot_catch = rowSums(unr.bet[,-1],na.rm=T)  ) |> 
              left_join(tot.trips) |> 
  mutate(bet.cpd = round(tot_catch/tot_trips,0) )

unr.bet <- unr.bet |> left_join(avg.bet |> select(landing_site_name, bet.cpd))
```

Unraised bigeye catch (kgs) reported in Tails:

```{r unr.bet}

flextable(unr.bet) |>  fontsize(size = 10, part = "all")

```

</details>

**Raised** catches are produced using the average catch per trip, raised by the best estimate of trips, to produce a representative estimate of total artisanal tuna catches. It should be **noted** that is there are sites with no catches reported, these are removed from the totals, even if effort was indicated by the member. This should be revisited - and an error message is noted in this document when that occurs.

<details>

<summary>Skipjack: SKJ</summary>

Raised catch estimates for skipjack tuna (kg) in `r params$year`:

```{r raise-skj}

# Only generating raised estimates where catch was reported
rs.skj <- unr.skj |>  select(1) |> rbind(tab8 |>  select(1)) |> distinct() |> data.frame()

for(i in 2:13){
  tmp = 
    data.frame(landing_site_name= rs.skj[,1]) |> 
    left_join(unr.skj[,c(1,i,14)])  |> 
    left_join(tab2[,c(1,i)]) |> 
    left_join(tab8[,c(1,i)])
  
  tmp$raised = NA
  for(j in 1:nrow(tmp)){
  tmp[j,'raised'] =  round(ifelse(tmp[j,2]==0 & tmp[j,4]==0, tmp[j,'skj.cpd'], tmp[j,2]/tmp[j,4])*tmp[j,5])
  }
  
  tmp <- tmp[,c(1,6)] 
  names(tmp)[2] <- paste(tolower(month.abb[i-1]),'skj','r',sep='_')
  
  rs.skj <- rs.skj |>  left_join(tmp)
}
  # Remove rows where no catch was reported - as no average exists...
  rs.skj$no_catch <- rowSums(rs.skj[, 2:13],na.rm=T )

  missing.skj = rs.skj |>  filter(no_catch==0)
  rs.skj <- rs.skj |>  filter(no_catch>0) |>  select(-no_catch)

flextable(rs.skj) |> colformat_num(j = 2:13, digits = 0) |>  fontsize(size = 8, part = "all")
```

<details>

<summary>Missing skipjack catch with effort</summary>

```{r missing.skj}
# Rows with no catch but some estimated fishing effort
flextable(missing.skj) |> colformat_num(j = 2:13, digits = 0) |>  fontsize(size = 8, part = "all")
```

</details>

</details>

<details>

<summary>Yellowfin: YFT</summary>

Raised catch estimates for yellowfin tuna (kg) in `r params$year`:

```{r raise-yft}

# Only generating raised estimates where catch was reported
rs.yft <- unr.yft |>  select(1) |> rbind(tab8 |>  select(1)) |> distinct()

for(i in 2:13){
  tmp = unr.yft[,c(1,i,14)]  |> left_join(tab2[,c(1,i)]) |> 
    left_join(tab8[,c(1,i)])
  
  tmp$raised = NA
  for(j in 1:nrow(tmp)){
  tmp[j,'raised'] =  round(ifelse(tmp[j,2]==0 & tmp[j,4]==0, tmp[j,'yft.cpd'], tmp[j,2]/tmp[j,4])*tmp[j,5])
  }
  
  tmp <- tmp[,c(1,6)] 
  names(tmp)[2] <- paste(tolower(month.abb[i-1]),'yft','r',sep='_')
  
  rs.yft <- rs.yft |>  left_join(tmp)
}

  # Remove rows where no catch was reported - as no average exists...
  rs.yft$no_catch <- rowSums(rs.yft[, 2:13],na.rm=T )

  missing.yft = rs.yft |>  filter(no_catch==0)
  rs.yft <- rs.yft |>  filter(no_catch>0) |>  select(-no_catch)

flextable(rs.yft) |> colformat_num(j = 2:13, digits = 0) |>  fontsize(size = 8, part = "all")
```

<details>

<summary>Missing yellowfin catch with effort</summary>

```{r missing.yft}
# Rows with no catch but some estimated fishing effort
flextable(missing.yft) |> colformat_num(j = 2:13, digits = 0) |>  fontsize(size = 8, part = "all")
```

</details>

</details>

<details>

<summary>Bigeye: BET</summary>

Raised catch estimates for bigeye tuna (kg) in `r params$year`:

```{r raise-bet}

# Only generating raised estimates where catch was reported
rs.bet <- unr.bet |>  select(1) |> rbind(tab8 |>  select(1)) |> distinct()

if(nrow(unr.bet>0)){
for(i in 2:13){
  tmp = unr.bet[,c(1,i,14)]  |> left_join(tab2[,c(1,i)]) |> 
    left_join(tab8[,c(1,i)])
  
  tmp$raised = NA
  for(j in 1:nrow(tmp)){
  tmp[j,'raised'] =  round(ifelse(tmp[j,2]==0 & tmp[j,4]==0, tmp[j,'bet.cpd'], tmp[j,2]/tmp[j,4])*tmp[j,5])
  }
  
  tmp <- tmp[,c(1,6)] 
  names(tmp)[2] <- paste(tolower(month.abb[i-1]),'bet','r',sep='_')
  
  rs.bet <- rs.bet |>  left_join(tmp)
}

  # Remove rows where no catch was reported - as no average exists...
  rs.bet$no_catch <- rowSums(rs.bet[, 2:13],na.rm=T )

  missing.bet = rs.bet |>  filter(no_catch==0)
  rs.bet <- rs.bet |>  filter(no_catch>0) |>  select(-no_catch)

flextable(rs.bet) |> colformat_num(j = 2:13, digits = 0) |>  fontsize(size = 8, part = "all")

}
```

<details>

<summary>Missing bigeye catch with effort</summary>

```{r missing.bet}
# Rows with no catch but some estimated fishing effort
if(exists('missing.bet')){
flextable(missing.bet) |> colformat_num(j = 2:13, digits = 0) |>  fontsize(size = 8, part = "all")
}
```

</details>

</details>

## Final Estimates

Here we take the raised catch estimates for the three key tuna species and sum them across all landing sites and months to produce an annual estimate in metric tonnes (mt).

```{r final.ace}
#| label: raised.ace
#| tbl-cap: Raised and unraised annual artisanal catch estimates in mt


unr.tmp = unr.skj |>  ungroup() |> select(-c(1,14)) |> summarise_all(sum, na.rm=T)
rs.tmp = rs.skj |> ungroup() |> select(-1)  |> summarise_all(sum, na.rm=T)
skj.art.ace = data.frame(
  sp = 'SKJ',
  unraised = round(rowSums(unr.tmp)/1000,2),
  raised = round(rowSums(rs.tmp)/1000,2)
)

unr.tmp = unr.yft |> ungroup() |> select(-c(1,14))  |> summarise_all(sum, na.rm=T)
rs.tmp = rs.yft |> ungroup() |> select(-1)  |> summarise_all(sum, na.rm=T)
yft.art.ace = data.frame(
  sp = 'YFT',
  unraised = round(rowSums(unr.tmp)/1000,2),
  raised = round(rowSums(rs.tmp)/1000,2)
)

if(exists("unr.bet")){
unr.tmp = unr.bet |> ungroup() |> select(-c(1,14)) |> summarise_all(sum, na.rm=T)
rs.tmp = rs.bet |> ungroup() |> select(-1)  |> summarise_all(sum, na.rm=T)

bet.art.ace = data.frame(
  sp = 'BET',
  unraised = round(rowSums(unr.tmp)/1000,2),
  raised = round(rowSums(rs.tmp)/1000,2)
)
}

# Produce final output

ace = rbind(skj.art.ace, yft.art.ace, bet.art.ace) |> 
  gather(key='Method', value='ACE', -1) |> 
  spread(key = sp, value=ACE)

flextable(ace) |>  fontsize(size = 12, part = "all")

```

```{r perc.sp}
#| label: ace.perc
#| tbl-cap: Percentage of the artisanal tuna ACE associated with each of the key species


ace$tot = rowSums(ace[,-1])
ace <- ace |>  mutate(SKJ = round(SKJ/tot*100,2),
                      YFT = round(YFT/tot*100,2),
                      BET = round(BET/tot*100,2)) |> 
                select(-tot)

flextable(ace)  |>  fontsize(size = 12, part = "all")


```
:::
