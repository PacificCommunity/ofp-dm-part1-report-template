---
title: "Generate Artisanal ACE"
author: "`r params$author`"
format: 
  html:
    page-layout: full
editor: visual
toc: true
toc-location: left
toccolor: blue
urlcolor: blue
embed-resources: true 
execute: 
  echo: false
  message: false
  warning: false
params:
  flag: 'CK'
  year: 2024
  author: "AUTHOR"
---

```{r}
# Load necessary libraries
library(DBI)
library(odbc)
library(tidyverse)
library(flextable)
source("utils.R")

# Define key vars
country_cd <- tolower(params$flag)
report_year = params$year
this_yr_folder = paste0("./data/report_", as.character(report_year), "_", tolower(country_cd), "/") |>
  tolower()
# Define years to use for tables and figures
yrs_long <- (params$year-4):params$year
yr_range <- paste(min(yrs_long),max(yrs_long), sep="-")

source("utils.R")
'%nin%' = function(x,y) !x %in% y            

```

```{r data-prep}

# Load all raw data - from t2
data_3615 <- read_and_clean(this_yr_folder, country_cd, r_code = 3615) |>
      mutate(across(where(is.character), tolower))

data_3527 <- read_and_clean(this_yr_folder, country_cd, r_code = 3527)|>
      mutate(across(where(is.character), tolower))

data_3614 <- read_and_clean(this_yr_folder, country_cd, r_code = 3614)|>
      mutate(across(where(is.character), tolower))

ika_trips_file = paste0(this_yr_folder, "ikasavea/", country_cd, "_trips_landing_site.csv")
if (file.exists(ika_trips_file)){
  data_ika_trips <- read.csv(paste0(this_yr_folder, "ikasavea/", country_cd, "_trips_landing_site.csv"))
}
if (nrow(data_ika_trips) == 0 && nrow(data_3615) == 0) {
  cat("No Ikasavea trip data found for this country/year. Document generation stopped.\n")
  knitr::knit_exit()
}

if (nrow(data_ika_trips) > 0){
   data_ika_trips <- data_ika_trips|>
    mutate(across(where(is.character), tolower)) |>
    janitor::clean_names() |>
    select(landing_site_name = landing_site, month,
           number_trips)
  
  df_ika_wide <- data_ika_trips %>%
    complete(landing_site_name, month = 1:12, fill = list(number_trips = 0)) %>%
    mutate(month = month.abb[month]) %>%
    pivot_wider(names_from = month, values_from = number_trips) %>%
    select(landing_site_name, all_of(month.abb))
  }

```

::: panel-tabset

## Methodology

The steps for preparing the artisanal catch estimates for key tuna species are outlined below, with the following tabs showing the catch and effort estimates that are used to prepare the final catch estimates. It should be noted that the Tails (and moving forward, Ikasavea) app captures a sample of the artisanal fishing activity. At this point, we do not have comprehensive surveys in place to scale up those estimates in a reliable and representative manner. Therefore, we are basing these estimates on a combination of reporting catch and effort as well as local expert knowledge of the activities at different landing sites.

In the future, we hope to progress the Frame Survey concept to being to refine the estimates of total effort that are used to scale up the sampled catch estimates reported in the respective applications.

1.  We provide a summary of number of trips by month and landing site from the TAILS trip and activity logs
2.  We compare to "rough" estimates of average monthly landings (trips) per month and landing site \[used if activity log data is unreliable/incomplete\]
3.  The tuna catch by landings site and month is calculated
4.  We then multiply the monthly CPUE (catch/trip) by the estimated number of trips, and if those data are missing, we use an average CPUE multiplied by the number of trips
5.  The artisanal ACE is the sum across all months and landing sites

Please also note that until this point, Iksavea and Tails are separate applications collecting data in separate places. Therefore, please review the Iksavea data (SPC can provide) and the T2 report (#3095) for other species that may be have been reported to supplement this assessment of key tuna catches.

## Fishing Effort

### Data prep: Effort

Below is a summary of the number of reported **trips** in `r params$year` by month and landing site, as reported in Tails. This table compares both fishing days and trips reported (using the number of motor and paddle vessel trips reported), and takes the maximum value as an estimate of trips.

<details>

<summary>Reported Trips - TAILS</summary>

```{r}
#| echo: false
#| results: 'asis'
#| label: Monthly-effort
#| tbl-cap: !expr if(nrow(data_3615) > 0) glue::glue("Number of trips per month and landing site reported in Tails") else ""

# Check if data exists
if (nrow(data_3615) == 0) {
  return(invisible(NULL))
}else{
  data_3615 <-  data_3615 |> select(-entity)
  flextable(data_3615) |>  
  width(j=1, width=1.2) |> 
  fontsize(size = 10, part = "all")
}
```

</details>

<details>

<summary>Reported Trips - IKASAVEA</summary>

If you have any artisanal data recorded in Ikasavea you see a table below with the number of trips per month.

```{r}
#| echo: false
#| results: 'asis'
#| label: tab2
#| tbl-cap: !expr if(nrow(data_ika_trips) == 0) glue::glue("Fishing trips reported in Ikasavea") else ""

if (nrow(data_ika_trips) == 0){
  return(invisible(NULL))
}else{
  flextable(df_ika_wide) |>  
  width(j=1, width=1.2) |> 
  fontsize(size = 10, part = "all")
}
```
</details>

<details>

<summary>Differences in Landing Sites </summary>

Below is a summary of all landing sites common to T2 and Ikasavea as well the ones unique to each of these sources (if any). Use this section to identify issues in landing site names between these two sources.

If no table is presented below it means you have artisanal data coming from a single source (Ikasavea OR Tails).

```{r}
#| echo: false
#| results: 'asis'
#| label: diff_t2_ika
#| tbl-cap: !expr if(nrow(data_ika_trips) == 0) glue::glue("Fishing trips reported in Ikasavea") else ""

if (nrow(data_ika_trips) > 0 && exists('data_3615') && is.data.frame(get('data_3615'))) {
  
  ls_t2  <- tolower(trimws(unique(data_3615$landing_site_name)))
  ls_ika <- tolower(trimws(unique(df_ika_wide$landing_site_name)))
  
  in_both    <- intersect(ls_t2, ls_ika)
  only_t2    <- setdiff(ls_t2, ls_ika)
  only_ika   <- setdiff(ls_ika, ls_t2)
  
  if (length(only_t2) == 0 && length(only_ika) == 0) {
    cat("✅ All landing site names match perfectly between both sources.\n")
  } else {
    
    # Summary table
    summary_df <- data.frame(
      ` ` = c("Matched in both", "Only in T2 (data_3615)", "Only in Ikasavea"),
      `Count` = c(length(in_both), length(only_t2), length(only_ika)),
      check.names = FALSE
    )
    
    # cat("### Landing site name comparison\n\n")
      flextable(summary_df) |>  
         width(j=1, width=1.2) |> 
        fontsize(size = 10, part = "all")

    
    # Table of mismatches
    if (length(only_t2) > 0 || length(only_ika) > 0) {
      max_len <- max(length(only_t2), length(only_ika))
      mismatch_df <- data.frame(
        `Only in T2 (data_3615)` = c(only_t2,  rep("", max_len - length(only_t2))),
        `Only in Ikasavea`       = c(only_ika, rep("", max_len - length(only_ika))),
        `In both` = c(in_both, rep("", max_len - length(in_both))),
        check.names = FALSE
      )
      # cat("\n### Unmatched landing site names\n\n")
      flextable(mismatch_df) |>  
         width(j=1, width=1.2) |> 
        fontsize(size = 10, part = "all")
    }
  }
}
```

</details>

<details>

<summary> Trips: IKASAVEA + TAILS </summary>

Below is result of the total number of trips considering both source (Tails and Ikasavea, in case you have data
coming from these two sources).

```{r}
#| echo: false
#| results: 'asis'


if (nrow(data_ika_trips) > 0 && exists('data_3615') && is.data.frame(get('data_3615'))) {

  prep <- function(df) {
    df %>%
      mutate(landing_site_name = tolower(trimws(landing_site_name))) %>%
      pivot_longer(-landing_site_name, names_to = "month", values_to = "trips") |>
      mutate(month = tolower(gsub("_trips", "", month)))
  }
  
  combined_t2_ika <- bind_rows(prep(data_3615), prep(df_ika_wide)) %>%
  group_by(landing_site_name, month) %>%
  summarise(trips = sum(trips), .groups = "drop") %>%
  mutate(month = factor(month, levels = tolower(month.abb))) %>%
  pivot_wider(names_from = month, values_from = trips) %>%
  arrange(landing_site_name) |>
  select(landing_site_name, tolower(month.abb))

  flextable(combined_t2_ika) |>  
  width(j=1, width=1.2) |> 
  fontsize(size = 10, part = "all")
}else{
  combined_t2_ika <- data.frame
  }
```

</details>

</details>

<details>

<summary>Local Knowledge - Trips</summary>

Read in member-estimated **trips** per month at each landing site. Some landing sites may not have any activity, that is OK. The member-provided estimates of effort by landing site and compared with the Tails reported effort to produce a 'best' estimate of effort.

```{r trips-est-mem}
#| echo: false
#| results: 'asis'
#| label: mem-trips
#| tbl-cap: !expr if(nrow(data_3615) > 0) glue::glue("Member reported estimated trips per month per landing site") else ""

est_trips_file <-  str_c(this_yr_folder,  'additional_files/est_trips.csv')

if (file.exists(est_trips_file)){
  est_trips = read.csv(est_trips_file) 
  flextable(est_trips)  |>  
    fontsize(size = 10, part = "all") |> 
    width(j=1, width=2)
}else{
  #pass
}

```

</details>

Below is a summary of the number of reported **days** in `r params$year` by month and landing site, as reported in Tails. This is used to estimate the number of trips per day.

### Best estimate of fishing trips

Now estimate monthly trips, based on the max value either reported by the member or reported in Tails and Ikasavea. In case you have data in Tails and Ikasavea the combination of trips in both sources will be used (tab above).

```{r, echo = F}
#TODO: choose which df to use, combined, TAils or ikasavea

if (nrow(combined_t2_ika)>0){
  combined <- combined_t2_ika |>
    mutate(landing_site_name = str_squish(landing_site_name))
  combined_tag <- c("Trips: IKASAVEA + TAILS")
}else if (nrow(data_ika_trips) == 0 && nrow(data_3615) > 0){
  combined <- data_3615|>
    mutate(landing_site_name = str_squish(landing_site_name))
  combined_tag <- c("Trips: TAILS")
}else if(nrow(data_3615) == 0 && nrow(data_ika_trips) > 0){
  combined <- data_ika_trips|>
    mutate(landing_site_name = str_squish(landing_site_name))
  combined_tag <- c("Trips: IKASAVEA")
}else{
  combined <- data.frame()
  combined_tag <- c("")
}
```

```{r max.trips}
#| echo: false
#| results: 'asis'
#| label: est-trips-monthly
#| tbl-cap: !expr if(nrow(combined) > 0) glue::glue("Best estimate of trips per month at each landing site") else ""
 
# Formerly Table 8 in old Excel

if (nrow(combined) > 0){
  if (file.exists(est_trips_file)){
    if (!all(c("landing_site_name", "est.trips") %in% colnames(est_trips))) {
      cat("Your estimated trip file has to have the following columns: 'landing_site_name', 'est.trips'")
      tab8 <- combined
    }else{
      
      # groom est_trips
      est_trips <- est_trips |>
        mutate(across(where(is.character), tolower)) |>
        mutate(landing_site_name = str_squish(landing_site_name))

      tab8 = combined |> full_join(est_trips |> select(landing_site_name, est.trips))
      tab8[is.na(tab8)] <- 0
      tab8 <- data.frame(tab8)
      for( i in 2:13){
        tab8[ ,i] = ifelse( tab8[ ,i] >  tab8[ ,14] ,  tab8[ ,i] , tab8[ ,14] )
        }

      # Get rid of sites that only have NAs
      tab8$num_na_cols <- rowSums(tab8[, 2:13] )

      tab8 <- tab8 |>  filter(num_na_cols>0) |>
        select(-c(est.trips, num_na_cols))

      # Now check for site with days but no trips -- just in case
      # tab8 <- tab8 |> rbind(tab2 |>  filter(landing_site_name %nin% tab8$landing_site_name))

      flextable(tab8)  |>  fontsize(size = 8, part = "all")

          }
  }
  else{
    cat(paste0("There is no member-estimated trips available, so the best estimate fishing is the table above: ", combined_tag))
    tab8 <- combined
  }
  }

```

## Catch Estimates

### Data prep: Catch

```{r}
# ── Month number → abbreviated name (keeps columns in calendar order) ─────────
month_labels <- c("Jan","Feb","Mar","Apr","May","Jun",
                  "Jul","Aug","Sep","Oct","Nov","Dec")

# ── Helper: pivot one subset to wide format ───────────────────────────────────
make_wide <- function(data) {
  data %>%
    # Sum sp_kg for each landing_site × month combination
    group_by(landing_site_name, month) %>%
    summarise(sp_kg = sum(sp_kg, na.rm = TRUE), .groups = "drop") %>%
    # Convert month numbers to abbreviated names
    mutate(month = month_labels[month]) %>%
    # Ensure all 12 months are present before pivoting
    complete(
      landing_site_name,
      month = month_labels,
      fill  = list(sp_kg = 0)
    ) %>%
    # Pivot to wide
    pivot_wider(
      names_from  = month,
      values_from = sp_kg,
      values_fill = 0          # missing combos → 0
    ) %>%
    # Reorder columns so months appear Jan → Dec (only those present in data)
    select(landing_site_name, any_of(month_labels))
}


# Check if data exists - if yes, reshape and create a df per sp
if (nrow(data_3614) > 0) {
  df_by_species <- data_3614 %>%
    group_by(sp_code) %>%
    group_map(~ make_wide(.x), .keep = FALSE) %>%
    setNames(sort(unique(data_3614$sp_code))) 
  
  df_bet <- df_by_species[["bet"]]
  df_skj <- df_by_species[["skj"]]
  df_yft <- df_by_species[["yft"]]
  }
# df_by_species[["YFT"]]   # yellowfin tuna only
# df_by_species[["SKJ"]]   # skipjack tuna only
```

**Unraised** tuna catches reported in Tails are illustrated below, in kilograms (kgs).

<details>

<summary>Skipjack: SKJ</summary>

```{r}
#| echo: false
#| results: 'asis'
#| label: data_skj
#| tbl-cap: !expr if(exists('df_skj') && is.data.frame(get('df_skj'))) glue::glue("Unraised skipjack catch (kgs) reported in Tails") else ""

# Check if data exists
if (nrow(df_by_species[["skj"]]) == 0) {
  return(invisible(NULL))
  }else{

    # Calculate total effort by landing site
    tot.trips = data.frame(landing_site_name = data_3527$landing_site_name,
                    tot_trips = rowSums(data_3527[,-1],na.rm=T))
    
    # Now calculate monthly average catch per trip (using tab2)
    avg.skj = data.frame(landing_site_name = df_skj$landing_site_name,
                    tot_catch = rowSums(df_skj[,-1],na.rm=T)) |>
                  left_join(tot.trips) |>
      mutate(skj.cpd = round(tot_catch/tot_trips,0))
    
    unr.skj <- df_skj  |> 
      left_join(avg.skj |> select(landing_site_name, skj.cpd))
    
    flextable(unr.skj) |>  
    width(j=1, width=1.2) |> 
    fontsize(size = 10, part = "all")
}

```

</details>

<details>

<summary>Yellowfin: YFT</summary>

```{r}
#| echo: false
#| results: 'asis'
#| label: df_yft
#| tbl-cap: !expr if(exists('df_yft') && is.data.frame(get('df_yft'))) glue::glue("Unraised yellowfin catch (kgs) reported in Tails") else ""

# Check if data exists
if (nrow(df_yft) == 0) {
  return(invisible(NULL))
  }else{

    # Calculate total effort by landing site
    tot.trips = data.frame(landing_site_name = data_3527$landing_site_name,
                    tot_trips = rowSums(data_3527[,-1],na.rm=T))
    
    # Now calculate monthly average catch per trip (using tab2)
    avg.yft = data.frame(landing_site_name = df_yft$landing_site_name,
                    tot_catch = rowSums(df_yft[,-1],na.rm=T)) |>
                  left_join(tot.trips) |>
      mutate(yft.cpd = round(tot_catch/tot_trips,0))
    
    unr.yft <- df_yft  |> 
      left_join(avg.yft |> select(landing_site_name, yft.cpd))
    
    flextable(unr.yft) |>  
    width(j=1, width=1.2) |> 
    fontsize(size = 10, part = "all")
}

```

</details>

<details>

<summary>Bigeye: BET</summary>

```{r}
#| echo: false
#| results: 'asis'
#| label: df_bet
#| tbl-cap: !expr if(exists('df_bet') && is.data.frame(get('df_bet'))) glue::glue("Unraised bigeye catch (kgs) reported in Tails") else ""

# Check if data exists
if (nrow(df_bet) == 0) {
  return(invisible(NULL))
  }else{

    # Calculate total effort by landing site
    tot.trips = data.frame(landing_site_name = data_3527$landing_site_name,
                    tot_trips = rowSums(data_3527[,-1],na.rm=T))
    
    # Now calculate monthly average catch per trip (using tab2)
    avg.bet = data.frame(landing_site_name = df_bet$landing_site_name,
                    tot_catch = rowSums(df_bet[,-1],na.rm=T)) |>
                  left_join(tot.trips) |>
      mutate(bet.cpd = round(tot_catch/tot_trips,0))
    
    unr.bet <- df_bet  |> 
      left_join(avg.bet |> select(landing_site_name, bet.cpd))
    
    flextable(unr.bet) |>  
    width(j=1, width=1.2) |> 
    fontsize(size = 10, part = "all")
}

```

</details>

**Raised** catches are produced using the average catch per trip, raised by the best estimate of trips, to produce a representative estimate of total artisanal tuna catches. It should be **noted** that is there are sites with no catches reported, these are removed from the totals, even if effort was indicated by the member. This should be revisited - and an error message is noted in this document when that occurs.

<details>

<summary>Skipjack: SKJ</summary>

Raised catch estimates for skipjack tuna (kg) in `r params$year`:

```{r}
estimate_best <- tab8 |>
  janitor::clean_names() |>
  mutate(landing_site_name = str_squish(landing_site_name)) |>
  pivot_longer(cols = 2:13, names_to = "months", values_to = "tot_trips_best")

spc_best <- combined |>
  janitor::clean_names() |>
  mutate(landing_site_name = str_squish(landing_site_name)) |>
  pivot_longer(cols = 2:13, names_to = "months", values_to = "tot_trips_spc")

## Filter and reshape unr
skj_long <- unr.skj |>
  janitor::clean_names() |>
  mutate(landing_site_name = str_squish(landing_site_name)) |>
  pivot_longer(cols = 2:13, names_to = "months", values_to = "unr_catch")

yft_long <- unr.yft |>
  janitor::clean_names() |>
  mutate(landing_site_name = str_squish(landing_site_name)) |>
  pivot_longer(cols = 2:13, names_to = "months", values_to = "unr_catch")

bet_long <- unr.bet |>
  janitor::clean_names() |>
  mutate(landing_site_name = str_squish(landing_site_name)) |>
  pivot_longer(cols = 2:13, names_to = "months", values_to = "unr_catch")

## calculate raised values per sp
rs.skj <- skj_long |>
  left_join(spc_best, by = c("landing_site_name", "months")) |>
  left_join(estimate_best, by = c("landing_site_name", "months")) |>
  mutate(raised = round(case_when(unr_catch == 0 & tot_trips_spc == 0 ~ skj_cpd * tot_trips_best,
                            .default = (unr_catch/tot_trips_spc) * tot_trips_best), 0))

rs.skj_wide <- rs.skj |>
  select(landing_site_name, months, raised) |>
  pivot_wider(id_cols = 1, names_from = "months", values_from = "raised")

# yft
rs.yft <- yft_long |>
  left_join(spc_best, by = c("landing_site_name", "months")) |>
  left_join(estimate_best, by = c("landing_site_name", "months")) |>
  mutate(raised = round(case_when(unr_catch == 0 & tot_trips_spc == 0 ~ yft_cpd * tot_trips_best,
                            .default = (unr_catch/tot_trips_spc) * tot_trips_best), 0))

rs.yft_wide <- rs.yft |>
  select(landing_site_name, months, raised) |>
  pivot_wider(id_cols = 1, names_from = "months", values_from = "raised")

# bet
rs.bet <- bet_long |>
  left_join(spc_best, by = c("landing_site_name", "months")) |>
  left_join(estimate_best, by = c("landing_site_name", "months")) |>
  mutate(raised = round(case_when(unr_catch == 0 & tot_trips_spc == 0 ~ bet_cpd * tot_trips_best,
                            .default = (unr_catch/tot_trips_spc) * tot_trips_best), 0))

rs.bet_wide <- rs.bet |>
  select(landing_site_name, months, raised) |>
  pivot_wider(id_cols = 1, names_from = "months", values_from = "raised")
```

```{r raise-skj}
# Remove rows where no catch was reported - as no average exists...
rs.skj_wide$no_catch <- rowSums(rs.skj_wide[, 2:13],na.rm=T )

missing.skj = rs.skj_wide |>  filter(no_catch==0)
rs.skj_wide <- rs.skj_wide |>  filter(no_catch>0) |>  select(-no_catch)

flextable(rs.skj_wide) |> colformat_num(j = 2:13, digits = 0) |>  fontsize(size = 8, part = "all")
```

<details>

<summary>Missing skipjack catch with effort</summary>

```{r missing.skj}
# Rows with no catch but some estimated fishing effort
if(nrow(missing.skj) > 0){
  flextable(missing.skj) |> colformat_num(j = 2:13, digits = 0) |>  fontsize(size = 8, part = "all")
}
```

</details>

</details>

<details>

<summary>Yellowfin: YFT</summary>

Raised catch estimates for yellowfin tuna (kg) in `r params$year`:

```{r raise-yft}

# Remove rows where no catch was reported - as no average exists...
rs.yft_wide$no_catch <- rowSums(rs.yft_wide[, 2:13],na.rm=T )

missing.yft = rs.yft_wide |>  filter(no_catch==0)
rs.yft_wide <- rs.yft_wide |>  filter(no_catch>0) |>  select(-no_catch)

flextable(rs.yft_wide) |> colformat_num(j = 2:13, digits = 0) |>  fontsize(size = 8, part = "all")
```


<details>

<summary>Missing yellowfin catch with effort</summary>

```{r missing.yft}
# Rows with no catch but some estimated fishing effort
if(nrow(missing.yft) > 0){
  flextable(missing.yft) |> colformat_num(j = 2:13, digits = 0) |>  fontsize(size = 8, part = "all")
}
```

</details>

</details>

<details>

<summary>Bigeye: BET</summary>

Raised catch estimates for bigeye tuna (kg) in `r params$year`:

```{r raise-bet}
# Remove rows where no catch was reported - as no average exists...
rs.bet_wide$no_catch <- rowSums(rs.bet_wide[, 2:13],na.rm=T )

missing.bet = rs.bet_wide |>  filter(no_catch==0)
rs.bet_wide <- rs.bet_wide |>  filter(no_catch>0) |>  select(-no_catch)

flextable(rs.bet_wide) |> colformat_num(j = 2:13, digits = 0) |>  fontsize(size = 8, part = "all")
```


<details>

<summary>Missing bigeye catch with effort</summary>

```{r missing.bet}
# Rows with no catch but some estimated fishing effort
if(nrow(missing.bet) > 0){
  flextable(missing.bet) |> colformat_num(j = 2:13, digits = 0) |>  fontsize(size = 8, part = "all")
}
```


</details>

</details>

## Final Estimates

Here we take the raised catch estimates for the three key tuna species and sum them across all landing sites and months to produce an annual estimate in metric tonnes (mt).

```{r final.ace}
#| label: raised.ace
#| tbl-cap: Raised and unraised annual artisanal catch estimates in mt

unr.tmp = unr.skj |>  ungroup() |> select(-c(1,14)) |> summarise_all(sum, na.rm=T)
rs.tmp = rs.skj_wide |> ungroup() |> select(-1)  |> summarise_all(sum, na.rm=T)
skj.art.ace = data.frame(
  sp = 'SKJ',
  unraised = round(rowSums(unr.tmp)/1000,2),
  raised = round(rowSums(rs.tmp)/1000,2)
)

unr.tmp = unr.yft |> ungroup() |> select(-c(1,14))  |> summarise_all(sum, na.rm=T)
rs.tmp = rs.yft_wide |> ungroup() |> select(-1)  |> summarise_all(sum, na.rm=T)
yft.art.ace = data.frame(
  sp = 'YFT',
  unraised = round(rowSums(unr.tmp)/1000,2),
  raised = round(rowSums(rs.tmp)/1000,2)
)

if(exists("unr.bet")){
unr.tmp = unr.bet |> ungroup() |> select(-c(1,14)) |> summarise_all(sum, na.rm=T)
rs.tmp = rs.bet_wide |> ungroup() |> select(-1)  |> summarise_all(sum, na.rm=T)

bet.art.ace = data.frame(
  sp = 'BET',
  unraised = round(rowSums(unr.tmp)/1000,2),
  raised = round(rowSums(rs.tmp)/1000,2)
)
}

# Produce final output

ace = rbind(skj.art.ace, yft.art.ace, bet.art.ace) |>
  gather(key='Method', value='ACE', -1) |>
  spread(key = sp, value=ACE)

flextable(ace) |>  fontsize(size = 12, part = "all")

```

```{r perc.sp}
#| label: ace.perc
#| tbl-cap: Percentage of the artisanal tuna ACE associated with each of the key species

ace$tot = rowSums(ace[,-1])
ace <- ace |>  mutate(SKJ = round(SKJ/tot*100,2),
                      YFT = round(YFT/tot*100,2),
                      BET = round(BET/tot*100,2)) |>
                select(-tot)

flextable(ace)  |>  fontsize(size = 12, part = "all")

```

:::
