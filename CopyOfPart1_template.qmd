---
title: "Annual Part 1 Report to the Western and Central Pacific Fisheries Commission"
author: "SPC - for UPDATE"
date: today
date-format: "DD MMMM YYYY"
format: 
  pdf:
    include-in-header: preamble.tex
    tbl-cap-location: bottom
    toc: false
    number-sections: true
    highlight-style: github
    
page-layout: full
edit: visual
params:
  country: 'Kiribati' # Name of country
  country_code: 'KI'          # 2-letter country code (all CAPS)
  year: 2024                  # Reporting year (max year of data)
  data_provided: 'Yes'        # Was SciData provided by deadline?
execute: 
  eval: true
  echo: false
  warning: false
  message: false
---

```{r libs}
library(tidyverse)
library(flextable)
library(scales) # Needed for commas in figure axis text
library(maps)
library(sf)

source("utils.R")

# Define the year
year <- params$year
member <- "ki" # todo: remove, this is hard coded just for dev purposes, prod should look like: params$flag
          # and attr name should be updated - has to be lowecase!
this_yr_folder = paste0("./data/report_2024_", tolower(member), "/") |>
  tolower()

'%nin%' = function(x,y) !x %in% y            


```


```{r header}
row1 <- glue::glue("Scientific data was provided to the Commission in accordance with the decision relating to the provision of scientific data to the Commission by 30 April {params$year+1}: [Yes/No]")
row2 <- "If no, please indicate the reason(s) and intended actions:"
row3 = row4 = row5 = ''

tab <- data.frame(lcol = c(row1, row2, row3, row4, row5), 
                  rcol = c(params$data_provided, rep("", 4)) )

ft <- flextable(tab)
# No header row
ft <- delete_rows(ft, i = 1, part = "header")
# Merge cells - there are a ton of merge_* functions - using this one for simplicity
ft <- merge_at(ft, i = 2:5, j = 1:2)
ft <- valign(ft, i = 2:5, valign = 'top') 
# Relative column width
ft <- width(ft, width = c(1, 0.1)) # Set relative width of columns
ft <- width(ft, width = dim(ft)$widths * 6.6 / (flextable_dim(ft)$widths)) 
ft <- border_outer(ft)
ft <- border_inner(ft)

ft
```


```{r}
#| label: prelims

# Country of interest
country_cd <- "ki"# update, params$country_code, has to be lower case
  
# Reporting year
report_year = params$year
  
# Define years to use for tables and figures
yrs_long <- (params$year-4):params$year
yr_range <- paste(min(yrs_long),max(yrs_long), sep="-")

  
# Read in ACE data for national fleet
# dat <- read.csv("data/ace_all_fleets.csv") 
# dat_cnt <- filter(dat, Flag == country_cd)
  
# Read in SSI observer data for national fleet
# dat_ssi <- read.csv(paste0("data/ssi_data_",country_cd,".csv") )

# Read in agg (BEST) data
# agg_dat <- read.csv(paste0("data/agg_all_gears_",params$country_code,".csv"))

# Map for plotting  
newmap = fortify(maps::map(wrap=c(0,360), plot=FALSE, fill=TRUE))  

# The suggested sets of species to put in this plot 
# -- based on the WCPFC part 1 guidelines document

# Create a vector of the key species to plot for each gear
# -- we will use this to make sure all other species are grouped into "OTHER"
# todo: note that the lower case options might not be necessary anymore
  PS_species <- c("SKIPJACK TUNA","YELLOWFIN TUNA","BIGEYE TUNA","ALBACORE","PACIFIC BLUEFIN TUNA")
  ps_species <- c("skj", "yft", "bet", "alb", "pbf")
  LL_species <- c("ALBACORE","YELLOWFIN TUNA","BIGEYE TUNA","PACIFIC BLUEFIN TUNA","SKIPJACK TUNA",
                  "BLACK MARLIN","BLUE MARLIN","STRIPED MARLIN","SWORDFISH")
  PL_species <- c("SKIPJACK TUNA","YELLOWFIN TUNA","BIGEYE TUNA","ALBACORE","PACIFIC BLUEFIN TUNA")
  
# Give species colours to maintain colour schemes throughout
# --This makes sure species colors are consistent in all plots

sp_colours <- setNames(object = c("seagreen3","red3","black","cyan1","steelblue","orange",
                                  "pink","wheat","purple3","grey40","dodgerblue4","purple4",
                                  "#66CCFF","salmon4","magenta3","gold"),
                         nm = c("ALBACORE","BIGEYE TUNA","BLACK MARLIN","BLUE MARLIN","BLUE SHARK",
                                "HAMMERHEAD SHARKS NEI","MAKO SHARKS","OCEANIC WHITETIP SHARK",
                                "PACIFIC BLUEFIN TUNA","SILKY SHARK","SKIPJACK TUNA",
                                "STRIPED MARLIN","SWORDFISH","THRESHER SHARKS NEI",
                                "WHALE SHARK","YELLOWFIN TUNA"))
  

# yr_tab <- 
#   dat_cnt |>  
#   filter(Year %in% yrs_long) |> 
#   group_by(Gear, Year, Species) |> 
#   summarise(Catch = sum(Catch))
#  
# # This is full species catch for all species, for each gear stacked
# yr_tab_wide <- 
#   yr_tab |>  
#   select(Gear, Year, Species, Catch) |> 
#   pivot_wider(names_from = Year, values_from = Catch, values_fill = 0) |> 
#   ungroup()
#   
# dat_pl <- 
#   dat_cnt |>  
#   mutate(species_ps = ifelse(Species %in% PS_species, Species, "OTHER"),
#          species_ll = ifelse(Species %in% LL_species, Species, "OTHER"),
#          species_pl = ifelse(Species %in% PL_species, Species, "OTHER")
#          )
  
```

\newpage

# Abstract / Summary

For inclusion in the SC summary report.

# Background

For example, a brief historical description of national fisheries in the WCPFC Convention Area.

# Flag State Reporting

Describe recent activities by national fleets (by gear type) in the Convention Area, including development/trends in each fishery (e.g. changes in fishing patterns, fleet operations, target species, trends in size composition, etc.).

## Annual catch estimates for the national purse seine fleet

```{r ps-prep}

# Purse seine
PS_tab <- 
  yr_tab_wide |>  
  filter(Gear == "Purse seine", Species %in% PS_species) |> 
  select(-Gear)

# Reorder year columns numerically
year_cols <- names(PS_tab)[grepl("^[0-9]{4}$", names(PS_tab))]
PS_tab <- PS_tab |> select(Species, sort(year_cols)) |> arrange(Species)

# Summarise numeric columns and add Species = "TOTAL"
PS_total <- PS_tab |> 
  summarise(across(where(is.numeric), sum)) |> 
  mutate(Species = "TOTAL")

# Bind the total row to the original table
PS_tab <- bind_rows(PS_tab, PS_total)

# Calculate total catch for reporting year
ps_catch = 
  dat_cnt |>  
  filter(Gear == "Purse seine", Year == report_year) |> 
  summarise(catch = sum(Catch, na.rm = TRUE)) |>  
  pull(catch)


data_3605 <- read_and_clean(this_yr_folder, member, r_code=3605) |>
  mutate(across(where(is.character), tolower))

data_3605_ps <- data_3605 |>
  filter(gear_code == "s") |>
  filter(sp_code %in% ps_species)

```

The annual catches of the primary species caught by the `r params$country` purse seine fleet are shown in @tbl-tbl1s.
```{r}
#| label: tbl-tbl1s
#| tbl-cap: !expr glue::glue("Annual catch estimates for the {params$country} purse seine fleet, by primary species and year, in the WCPFC Convention Area")

  
flextable(PS_tab) |>  
  set_table_properties(width = 0.7, align = "center") |> 
  width(j = 1, width = 2)

```

## Annual catch estimates for the national longline fleet

```{r}
#| label: tbl-tbl1l  #!expr glue::glue("This should be {params$txt}")
#| tbl-cap: !expr glue::glue("Annual catch estimates for the {params$country} longline fleet, by primary species and year, in the WCPFC Convention Area over {yr_range}")

# Longline
LL_tab <- 
  yr_tab_wide |>  
  filter(Gear == "Longline", Species %in% LL_species) |> 
  select(-Gear)

# Reorder year columns numerically
year_cols <- names(LL_tab)[grepl("^[0-9]{4}$", names(LL_tab))]
LL_tab <- LL_tab |> select(Species, sort(year_cols)) |> arrange(Species)

# Summarise numeric columns and add Species = "TOTAL"
LL_total <- LL_tab |> 
  summarise(across(where(is.numeric), sum)) |> 
  mutate(Species = "TOTAL")

# Bind the total row to the original table
LL_tab <- bind_rows(LL_tab, LL_total)

# Display table
flextable(LL_tab) |>  
  set_table_properties(width = 0.7, align = "center") |> 
  width(j = 1, width = 2)

```

<!-- ## Annual catch estimates for the national pole and line fleet -->

<!-- ```{r} -->
<!-- #| label: tbl-tbl1p -->
<!-- #| tbl-cap: !expr glue::glue("Annual catch estimates for the {params$country} pole and line fleet, by primary species and year, in the WCPFC Convention Area over {yr_range}") -->

<!-- # Pole and line -->
<!-- PL_tab <-  -->
<!--   yr_tab_wide |>   -->
<!--   filter(Gear == "Pole-and-line", Species %in% PL_species) |>  -->
<!--   select(-Gear) -->

<!-- # Reorder year columns numerically -->
<!-- year_cols <- names(PL_tab)[grepl("^[0-9]{4}$", names(PL_tab))] -->
<!-- PL_tab <- PL_tab |> select(Species, sort(year_cols)) |> arrange(Species) -->

<!-- # Summarise numeric columns and add Species = "TOTAL" -->
<!-- PL_total <- PL_tab |>  -->
<!--   summarise(across(where(is.numeric), sum)) |>  -->
<!--   mutate(Species = "TOTAL") -->

<!-- # Bind the total row to the original table -->
<!-- PL_tab <- bind_rows(PL_tab, PL_total) -->

<!-- # Display table -->
<!-- flextable(PL_tab) |>   -->
<!--   set_table_properties(width = 0.7, align = "center") |>  -->
<!--   width(j = 1, width = 2) -->

<!-- ``` -->

##  Historical annual catch estimates for the national purse seine fleet

```{r}
#| echo: false
#| message: false
#| warning: false
#| results: 'asis'
#| fig-pos: 'H'
#| label: fig-fig1s
#| fig-cap: !expr glue::glue("Historical annual catch estimates for the {params$country} purse seine fleet, by primary species and year, in the WCPFC Convention Area")
#| fig-width: 12
#| fig-height: 7
#| fig-align: "center"

# Purse seine
PS_pl <- 
  dat_pl |>  
  filter(Year %in% yrs_long, Gear == "Purse seine", Species %in% PS_species) |> 
  group_by(Year, Species) |> 
  summarise(Catch = sum(Catch)) |> 
  ungroup()
  
ref_df <- expand_grid(Year = yrs_long, Species = PS_species)
  
PS_pl <- 
  left_join(ref_df, PS_pl, by = c("Year","Species")) |> 
   mutate(across(everything(), ~replace_na(.x, 0)))

  
print(
ggplot(PS_pl, aes(x = Year, y = Catch, colour = Species)) + 
  geom_line(linewidth = 1.5) + geom_point(size = 5) +
  scale_colour_manual(values = sp_colours) +
  scale_x_continuous(breaks = seq(min(PS_pl$Year),max(PS_pl$Year),3)) + 
  scale_y_continuous(labels = comma) +
  xlab(element_blank()) + ylab("Catch (mt)") + theme_bw() +
  theme(axis.title = element_text(size = 16), axis.text = element_text(size = 16),
  legend.position = "bottom", legend.title = element_blank(),
  legend.text = element_text(size = 13))
)

```

## Historical annual catch estimates for the national longline fleet

```{r}
#| label: fig-fig1l
#| fig-pos: 'H'
#| fig-cap: !expr glue::glue("Historical annual catch estimates for the {params$country} longline fleet, by primary species and year, in the WCPFC Convention Area")
#| fig-width: 12
#| fig-height: 7
#| fig-align: "center"

# Longline
  
LL_pl <- 
  dat_pl |>  
  filter(Year %in% yrs_long, Gear == "Longline", Species %in% LL_species) |> 
  group_by(Year, Species) |> 
  summarise(Catch = sum(Catch), Catch_unadj = sum(Unadj_Catch))
  
ref_df <- expand_grid(Year = yrs_long, Species = LL_species)
  
LL_pl <- 
  left_join(ref_df, LL_pl, by = c("Year","Species")) |> 
   mutate(across(everything(), ~replace_na(.x, 0)))
  
  
ggplot(LL_pl, aes(x = Year, y = Catch, colour = Species)) + 
  geom_line(linewidth = 1.5) + geom_point(size = 5) +
  scale_colour_manual(values = sp_colours) +
  scale_x_continuous(breaks = seq(min(LL_pl$Year),max(LL_pl$Year),3)) + 
  scale_y_continuous(labels = comma) +
  xlab(element_blank()) + ylab("Catch (mt)") + theme_bw() +
  theme(axis.title = element_text(size = 16), axis.text = element_text(size = 16),
  legend.position = "bottom", legend.title = element_blank(),
  legend.text = element_text(size = 13))
  
```

<!-- ## Historical annual catch estimates for the national pole and line fleet -->

<!-- ```{r} -->
<!-- #| label: fig-fig1p -->
<!-- #| fig-pos: 'H' -->
<!-- #| fig-cap: !expr glue::glue("Historical annual catch estimates for the {params$country} pole and line fleet, by primary species and year, in the WCPFC Convention Area") -->
<!-- #| fig-width: 12 -->
<!-- #| fig-height: 7 -->
<!-- #| fig-align: "center" -->

<!-- # Pole and line -->

<!-- PL_pl <-  -->
<!--   dat_pl |>   -->
<!--   filter(Year %in% yrs_long, Gear == "Pole-and-line", Species %in% PL_species) |>  -->
<!--   group_by(Year, Species) |>  -->
<!--   summarise(Catch = sum(Catch), Catch_unadj = sum(Unadj_Catch)) -->

<!-- ref_df <- expand_grid(Year = yrs_long, Species = PL_species) -->

<!-- PL_pl <-  -->
<!--   left_join(ref_df, PL_pl, by = c("Year","Species")) |>  -->
<!--    mutate(across(everything(), ~replace_na(.x, 0))) -->

<!-- ggplot(PL_pl, aes(x = Year, y = Catch, colour = Species)) +  -->
<!--   geom_line(linewidth = 1.5) + geom_point(size = 5) + -->
<!--   scale_colour_manual(values = sp_colours) + -->
<!--   scale_x_continuous(breaks = seq(min(PL_pl$Year),max(PL_pl$Year),3)) +  -->
<!--   scale_y_continuous(labels = comma) + -->
<!--   xlab(element_blank()) + ylab("Catch (mt)") + theme_bw() + -->
<!--   theme(axis.title = element_text(size = 16), axis.text = element_text(size = 16), -->
<!--   legend.position = "bottom", legend.title = element_blank(), -->
<!--   legend.text = element_text(size = 13)) -->

<!-- ``` -->

## Historical annual vessel numbers for the national fleet

```{r}
#| label: fig-fig2
#| fig-pos: 'H'
#| fig-cap: !expr glue::glue("Historical annual vessel numbers for the {params$country} fleet, by gear, for the WCPFC Convention Area")
#| fig-width: 12
#| fig-height: 7
#| fig-align: "center"

# Plot of vessel numbers for only Longline and Purse seine, aggregated over size class
ves_calcs <- 
  dat_cnt |>  
  filter(Year %in% yrs_long, Gear %in% c("Purse seine", "Longline")) |>  # âœ… Include only LL and PS
  select(Flag, Fleet, Year, Gear, vessels_sml, vessels_med, vessels_lge, vessels_hge) |> 
  distinct() |> 
  mutate(Vessels = rowSums(across(starts_with("vessels_")), na.rm = TRUE)) |> 
  group_by(Year, Gear) |> 
  summarise(Vessels = sum(Vessels), .groups = "drop")

ggplot(ves_calcs, aes(x = Year, y = Vessels, colour = Gear)) +
  geom_line(linewidth = 1.5) + 
  geom_point(size = 5) + 
  theme_bw() +
  scale_colour_manual(values = c("Purse seine" = "lightblue", "Longline" = "steelblue")) +
  scale_x_continuous(breaks = seq(min(ves_calcs$Year), max(ves_calcs$Year), 3)) +
  xlab(NULL) + ylab("Number of vessels in fleet") +
  theme(
    axis.title = element_text(size = 16), 
    axis.text = element_text(size = 16),
    legend.position = "bottom", 
    legend.title = element_blank(),
    legend.text = element_text(size = 13)
  )
```

## Number of active vessels by gear and size category over recent years

```{r}
ves_raw <- 
  dat_cnt |>  
  filter(Year %in% yrs_long) |> 
  select(Flag, Fleet, Year, Gear, vessels_sml, vessels_med, vessels_lge, vessels_hge) |> 
  distinct()
```

```{r}
#| label: tbl-tbl2-longline
#| tbl-cap: !expr glue::glue("Number of {params$country} longline vessels, by size category, active in the WCPFC Convention Area, over {yr_range}")
#| echo: false
#| results: 'asis'

ves_ll <- ves_raw |>  
  filter(Gear == "Longline") |>
  group_by(Year, Gear) |> 
  summarise(
    '0 - 50' = sum(vessels_sml),
    '51 - 200' = sum(vessels_med),
    '201 - 500' = sum(vessels_lge),
    '500+' = sum(vessels_hge),
    .groups = "drop"
  )

if (sum(ves_ll[,-c(1:2)]) > 0) {
  ves_ll |> 
    pivot_longer(-c(Year, Gear), names_to = "Size Category (GRT)", values_to = "Vessels") |>
    pivot_wider(names_from = Year, values_from = Vessels, values_fill = 0) |>
    group_by(Gear) |> 
    mutate(Gear = ifelse(row_number() == 1, Gear, "")) |>
    flextable() |>  
    set_table_properties(width = 0.7, align = "center") |> 
    width(j = 1:2, width = 1.2)
}
```

```{r}
#| label: tbl-tbl2-ps
#| tbl-cap: !expr glue::glue("Number of {params$country} purse seine vessels, by size category, active in the WCPFC Convention Area, over {yr_range}")
#| echo: false
#| results: 'asis'

ves_ps <- ves_raw |>  
  filter(Gear == "Purse seine") |>
  group_by(Year, Gear) |> 
  summarise(
    '0 - 500' = sum(vessels_sml),
    '501 - 1000' = sum(vessels_med),
    '1001 - 1500' = sum(vessels_lge),
    '1500+' = sum(vessels_hge),
    .groups = "drop"
  )

if (sum(ves_ps[,-c(1:2)]) > 0) {
  ves_ps |> 
    pivot_longer(-c(Year, Gear), names_to = "Size Category (GRT)", values_to = "Vessels") |>
    pivot_wider(names_from = Year, values_from = Vessels, values_fill = 0) |>
    group_by(Gear) |> 
    mutate(Gear = ifelse(row_number() == 1, Gear, "")) |>
    flextable() |>  
    set_table_properties(width = 0.7, align = "center") |> 
    width(j = 1:2, width = 1.2)
}

```


<!-- ```{r} -->
<!-- #| label: tbl-tbl2-pl -->
<!-- #| tbl-cap: !expr glue::glue("Number of {params$country} pole-and-line vessels, by size category, active in the WCPFC Convention Area, over {yr_range}") -->
<!-- #| echo: false -->
<!-- #| results: 'asis' -->

<!-- ves_pl <- ves_raw |>   -->
<!--   filter(Gear == "Pole-and-line") |> -->
<!--   group_by(Year, Gear) |>  -->
<!--   summarise( -->
<!--     '0 - 50' = sum(vessels_sml), -->
<!--     '51 - 150' = sum(vessels_med), -->
<!--     '150+' = sum(vessels_lge + vessels_hge), -->
<!--     .groups = "drop" -->
<!--   ) -->

<!-- if (sum(ves_pl[,-c(1:2)]) > 0) { -->
<!--   ves_pl |>  -->
<!--     pivot_longer(-c(Year, Gear), names_to = "Size Category (GRT)", values_to = "Vessels") |> -->
<!--     pivot_wider(names_from = Year, values_from = Vessels, values_fill = 0) |> -->
<!--     group_by(Gear) |>  -->
<!--     mutate(Gear = ifelse(row_number() == 1, Gear, "")) |> -->
<!--     flextable() |>   -->
<!--     set_table_properties(width = 0.7, align = "center") |>  -->
<!--     width(j = 1:2, width = 1.2) -->
<!-- } -->
<!-- ``` -->



<!-- ```{r} -->
<!-- #| label: tbl-tbl2-troll -->
<!-- #| tbl-cap: !expr glue::glue("Number of {params$country} troll vessels, by size category, active in the WCPFC Convention Area, over {yr_range}") -->
<!-- #| echo: false -->
<!-- #| results: 'asis' -->

<!-- ves_tr <- ves_raw |>   -->
<!--   filter(Gear == "Troll") |> -->
<!--   group_by(Year, Gear) |>  -->
<!--   summarise( -->
<!--     '0 - 50' = sum(vessels_sml), -->
<!--     '51 - 150' = sum(vessels_med), -->
<!--     '150+' = sum(vessels_lge + vessels_hge), -->
<!--     .groups = "drop" -->
<!--   ) -->

<!-- if (sum(ves_tr[,-c(1:2)]) > 0) { -->
<!--   ves_tr |>  -->
<!--     pivot_longer(-c(Year, Gear), names_to = "Size Category (GRT)", values_to = "Vessels") |> -->
<!--     pivot_wider(names_from = Year, values_from = Vessels, values_fill = 0) |> -->
<!--     group_by(Gear) |>  -->
<!--     mutate(Gear = ifelse(row_number() == 1, Gear, "")) |> -->
<!--     flextable() |>   -->
<!--     set_table_properties(width = 0.7, align = "center") |>  -->
<!--     width(j = 1:2, width = 1.2) -->
<!-- } -->
<!-- ``` -->



<!-- ```{r} -->
<!-- #| label: tbl-tbl2-other-summary -->
<!-- #| tbl-cap: !expr glue::glue("Total number of vessels for other gear types (without size classification), active in the WCPFC Convention Area, over {yr_range}") -->
<!-- #| echo: false -->
<!-- #| results: 'asis' -->

<!-- library(dplyr) -->
<!-- library(tidyr) -->
<!-- library(flextable) -->

<!-- known_gears <- c("Longline", "Purse seine", "Pole-and-line", "Troll") -->

<!-- ves_other_summary <- dat_cnt |>   -->
<!--   filter(Year %in% yrs_long, !Gear %in% known_gears) |>  -->
<!--   distinct(Gear, Year, vessels) |>     # Avoid duplication -->
<!--   pivot_wider(names_from = Year, values_from = vessels, values_fill = 0) |>  -->
<!--   mutate(`Size Category (GRT)` = "") |>  -->
<!--   relocate(`Size Category (GRT)`, .after = Gear) -->

<!-- # Sort year columns numerically -->
<!-- year_cols <- names(ves_other_summary)[grepl("^\\d{4}$", names(ves_other_summary))] -->
<!-- year_cols <- sort(as.numeric(year_cols)) |> as.character()  # Ensure correct order -->

<!-- ves_other_summary <- ves_other_summary |>  -->
<!--   select(Gear, `Size Category (GRT)`, all_of(year_cols)) -->

<!-- # Output only if there's any vessel data -->
<!-- if (nrow(ves_other_summary) > 0 && sum(select(ves_other_summary, where(is.numeric))) > 0) { -->
<!--   flextable(ves_other_summary) |> -->
<!--     set_table_properties(layout = "autofit", width = 0.9, align = "center") |> -->
<!--     colformat_int(big.mark = ",") |> -->
<!--     fontsize(size = 9, part = "all") |> -->
<!--     width(j = 1:2, width = 1.5) |> -->
<!--     align(align = "center", part = "all") |> -->
<!--     padding(padding.left = 5, padding.right = 5, part = "all") -->
<!-- } -->
<!-- ``` -->

## Distribution of catches of target species for different national fisheries

```{r}
#| label: fig-figmap
#| fig-cap: !expr glue::glue("Map showing the distribution of target species catch (mt) for the {params$country} purse seine fishery.")
#| fig-width: 13
#| fig-height: 13
#| fig-align: "center"

agg_dat_full <- 
  agg_dat |>  
  mutate(lat =Lat,
         lon = Lon)


# I'm commenting out the EEZ for now as it slows the render considerably
# Get EEZs and other boundaries for the world

# ALL_EEZ <- st_read("Marine_Regions_V10/World_EEZ_v10_2018_0_360.shp", quiet=T)
# ALL_EEZ <- ALL_EEZ |>  filter(x_1>100, x_1<250, y_1>-50,y_1<30)

ps_spp_yr <- 
  agg_dat_full |>  
  filter(between(Year, params$year-4, params$year) , 
         Gear_code == "S", 
         SP_code %in% c("BET","SKJ","YFT")) |> 
  group_by(lat, lon, Year, Species) |> 
  summarise(Catch = sum(Catch))|> 
  filter(Catch>0)

if (nrow(ps_spp_yr) > 0) {
pl <- ggplot() +
   # geom_sf(data = ALL_EEZ, fill = NA, col = "gray30", linewidth = .1) +
    geom_map(data=newmap, map=newmap, aes(map_id=region), fill='bisque1', col='gray') + 
    geom_tile(data = ps_spp_yr, aes(lon, lat, fill = Catch)) +
    scale_fill_distiller(palette = "Spectral") +
    scale_x_continuous(limits = c(120,230), expand = c(0,0), breaks = seq(140,220,40)) +
    scale_y_continuous(limits = c(-35,25), expand = c(0,0)) +
    facet_grid(Year ~ Species) +
    xlab("Longitude") + ylab("Latitude") + labs(fill = "Catch (mt)") +
    theme_bw() +
     theme(axis.text = element_text(size=18), 
           legend.text = element_text(size=18), 
           legend.title = element_text(size=18),
           strip.background = element_rect(fill='white'), 
           strip.text = element_text(size=18), 
           axis.title = element_text(size=20), title = element_text(size=20)
           ) + 
    coord_sf() +
    ggtitle('Spatial patterns in catch for the purse seine fishery')

  print(pl)
} else {
  message("No data available for purse seine species map.")
}

```

```{r}
#| label: fig-figmapl
#| fig-cap: !expr glue::glue("Map showing the distribution of target species catch (mt) for the {params$country} longline fishery.")
#| fig-width: 13
#| fig-height: 13
#| fig-align: "center"


ll_spp_yr <- 
  agg_dat_full |>  
  filter(between(Year, params$year-4, params$year) , 
         Gear_code == "L", 
         SP_code %in% c("BET","ALB","YFT")) |> 
         group_by(lat, lon, Year, Species) |> 
         summarise(Catch = sum(Catch)) |> 
         filter(Catch>0)

if (nrow(ll_spp_yr) > 0) {
pl <- ggplot() +
   # geom_sf(data = ALL_EEZ, fill = NA, col = "gray30", linewidth = .1) +
    geom_map(data=newmap, map=newmap, aes(map_id=region), fill='bisque1', col='gray') + 
    geom_tile(data = ll_spp_yr, aes(lon, lat, fill = Catch), col='white') +
    scale_fill_distiller(palette = "Spectral") +
    scale_x_continuous(limits = c(120,230), expand = c(0,0), breaks = seq(140,220,40)) +
    scale_y_continuous(limits = c(-35,25), expand = c(0,0)) +
    facet_grid(Year ~ Species) +
    xlab("Longitude") + ylab("Latitude") + labs(fill = "Catch (mt)") +
    theme_bw() +
        theme(axis.text = element_text(size=18), 
           legend.text = element_text(size=18), 
           legend.title = element_text(size=18),
           strip.background = element_rect(fill='white'), 
           strip.text = element_text(size=18), 
           axis.title = element_text(size=20), title = element_text(size=20)
           ) + 
    coord_sf() +
    ggtitle('Spatial patterns in catch for the longline fishery')

  print(pl)
} else {
  message("No data available for longline species map.")
}

```

## Captures of species of special interest (SSIs)
Note that the tables below are specified to include - seabird, turtle and marine mammals in the instructions but we also include things like some rays and sharks. Note that Alive plus Dead does not necessarily equal Total due to unknowns. PW has no SSI captures and TK and NU have no flagged fleets

### Observed catches of SSIs by the purse seine fleet

```{r}
#| label: tbl-tbl3s
#| tbl-cap: !expr glue::glue("Observed annual estimated catches of species of special interest (seabird, turtle and marine mammals) by the {params$country} purse seine fleet, in the WCPFC Convention Area, for years {yr_range}, to the extent possible. Note that the Total may not reflect the sum of Alive and Dead as some animals are reported with an Unknown status.")

tab_ps <- 
  dat_ssi |>  
  filter(Gear == "S") |> 
  select(-c(flag_id,Gear)) 

flextable(tab_ps) |> 
  set_table_properties(layout = "autofit", width = 0.95, align = "center") |> 
  fontsize(size = 9, part = "all") |> 
  colformat_num(j = "Year", big.mark = "") |>  
  width(j = c("Category", "Species"), width = 1.5) |> 
  align(align = "center", part = "all") |> 
  padding(padding.left = 5, padding.right = 5, part = "all")
```

### Observed catches of SSIs by the longline fleet

```{r}
#| label: tbl-tbl3l
#| tbl-cap: !expr glue::glue("Observed annual estimated catches of species of special interest (seabird, turtle and marine mammals) by the {params$country} longline fleet, in the WCPFC Convention Area, for years {yr_range}")

tab_ll <- 
  dat_ssi |>  
  filter(Gear == "L") |>   
  select(-c(flag_id,Gear)) 

flextable(tab_ll) |> 
 set_table_properties(layout = "autofit", width = 0.95, align = "center") |> 
  fontsize(size = 9, part = "all") |> 
  colformat_num(j = "Year", big.mark = "") |>  
  width(j = c("Category", "Species"), width = 1.5) |> 
  align(align = "center", part = "all") |> 
  padding(padding.left = 5, padding.right = 5, part = "all")
```


## Annual catch estimates for non-target, associated and dependent species for the national purse seine fleet

```{r}
# Create non-target purse seine table
# Create table of non-target species for purse seine
PS_tab <- 
  dat_cnt |>  
  filter(Gear == "Purse seine", 
         Year %in% yrs_long,
         !Species %in% PS_species) |>  # Exclude only the key species
  group_by(Species, Year) |> 
  summarise(Catch = sum(Catch, na.rm = TRUE), .groups = "drop") |> 
  pivot_wider(names_from = Year, values_from = Catch, values_fill = 0) |> 
  arrange(Species)
```

```{r}
#| label: tbl-tbl4s
#| tbl-cap: !expr glue::glue("Annual estimated catches of non-target, associated and dependent species, including sharks, by the {params$country} purse seine fleet, in the WCPFC Convention Area over {yr_range}")
#| echo: false
#| results: 'asis'

# Ensure required columns are present even when empty
required_cols <- c("Species", as.character((params$year - 4):params$year))
if (nrow(PS_tab) == 0) {
  PS_tab <- tibble(Species = character()) |> 
    bind_cols(as_tibble(matrix(0, nrow = 0, ncol = length(required_cols) - 1,
                               dimnames = list(NULL, required_cols[-1]))))
}

# Always render the table
flextable(PS_tab) |>  
  set_table_properties(layout = "autofit", width = 0.95, align = "center") |> 
  fontsize(size = 9, part = "all") |> 
  width(j = 1, width = 2) |> 
  colformat_num(big.mark = ",") |> 
  align(align = "center", part = "all") |> 
  padding(padding.left = 5, padding.right = 5, part = "all")
```

## Annual catch estimates for non-target, associated and dependent species for the national longline fleet

```{r}
# Create table of non-target species for longline
LL_tab <- 
  dat_cnt |>  
  filter(Gear == "Longline", 
         Year %in% yrs_long,
         !Species %in% LL_species) |>  # Exclude key longline species
  group_by(Species, Year) |> 
  summarise(Catch = sum(Catch, na.rm = TRUE), .groups = "drop") |> 
  pivot_wider(names_from = Year, values_from = Catch, values_fill = 0) |> 
  arrange(Species)
```

```{r}
#| label: tbl-tbl4l
#| tbl-cap: !expr glue::glue("Annual estimated catches of non-target, associated and dependent species, including sharks, by the {params$country} longline fleet, in the WCPFC Convention Area over {yr_range}")
#| echo: false
#| results: 'asis'

# Ensure LL_tab has all expected columns even if empty
required_cols <- c("Species", as.character((params$year - 4):params$year))
if (nrow(LL_tab) == 0) {
  LL_tab <- tibble(Species = character()) |> 
    bind_cols(as_tibble(matrix(0, nrow = 0, ncol = length(required_cols) - 1,
                               dimnames = list(NULL, required_cols[-1]))))
}

# Always render the table
flextable(LL_tab) |>  
  set_table_properties(layout = "autofit", width = 0.95, align = "center") |> 
  fontsize(size = 9, part = "all") |> 
  width(j = 1, width = 2) |> 
  colformat_num(big.mark = ",") |> 
  align(align = "center", part = "all") |> 
  padding(padding.left = 5, padding.right = 5, part = "all")
  
```

<!-- ## Annual catch estimates for non-target, associated and dependent species for the national pole and line fleet -->

<!-- ```{r} -->
<!-- # Create table of non-target species for pole-and-line -->
<!-- PL_tab <-  -->
<!--   dat_cnt |>   -->
<!--   filter(Gear == "Pole-and-line",  -->
<!--          Year %in% yrs_long, -->
<!--          !Species %in% PL_species) |>  # Exclude key PL species -->
<!--   group_by(Species, Year) |>  -->
<!--   summarise(Catch = sum(Catch, na.rm = TRUE), .groups = "drop") |>  -->
<!--   pivot_wider(names_from = Year, values_from = Catch, values_fill = 0) |>  -->
<!--   arrange(Species) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- #| label: tbl-tbl4p -->
<!-- #| tbl-cap: !expr glue::glue("Annual estimated catches of non-target, associated and dependent species, including sharks, by the {params$country} pole and line fleet, in the WCPFC Convention Area over {yr_range}") -->
<!-- #| echo: false -->
<!-- #| results: 'asis' -->

<!-- # Ensure PL_tab has all expected columns even if empty -->
<!-- required_cols <- c("Species", as.character((params$year - 4):params$year)) -->
<!-- if (nrow(PL_tab) == 0) { -->
<!--   PL_tab <- tibble(Species = character()) |>  -->
<!--     bind_cols(as_tibble(matrix(0, nrow = 0, ncol = length(required_cols) - 1, -->
<!--                                dimnames = list(NULL, required_cols[-1])))) -->
<!-- } -->

<!-- flextable(PL_tab) |>   -->
<!--   set_table_properties(layout = "autofit", width = 0.95, align = "center") |>  -->
<!--   fontsize(size = 9, part = "all") |>  -->
<!--   width(j = 1, width = 2) |>  -->
<!--   colformat_num(big.mark = ",") |>  -->
<!--   align(align = "center", part = "all") |>  -->
<!--   padding(padding.left = 5, padding.right = 5, part = "all") -->

<!-- ``` -->


# Coastal State Reporting

Describe recent activities by foreign and domestic fleets in the waters of national jurisdiction, including development/trends in each fishery (e.g. changes in fishing patterns, fleet operations, target species, trends in size composition, etc.).

# Socio-economic factors

Associated socioeconomic factors (which may influence or explain the above trends).

# Disposal of catch

Disposal of catch (fresh/frozen/other) / market destination (export/domestic).

<!-- ```{r} -->
<!-- #| label: tbl-tbldis -->
<!-- #| tbl-cap: !expr glue::glue("Summary of the disposal of catches in {params$country} ports from the fishing fleets (purse seine, longline, pole and line) operating in {params$country} in {params$year}") -->

<!-- dis_dat <- read.csv("data/catch_disposals.csv") -->

<!-- flextable(dis_dat) |>  -->
<!--   set_table_properties(layout = "fixed", width = 0.95) |>  -->
<!--   fontsize(size = 5, part = "all") |>  -->
<!--   set_header_labels(values =    -->
<!--                       c("Activities",rep(c("PS","LL","PL"),time=2),rep(c("PS","LL"),time=5)) ) |>  -->
<!--     add_header_row(values =  -->
<!--                      c("","Skipjack(mt)","Yellowfin(mt)","Bigeye(mt)", -->
<!--                        "Albacore(mt)","Billfish(mt)","Sharks(mt)","Other(mt)"), -->
<!--                    colwidths = c(1,3,3,2,2,2,2,2)) |>  -->
<!--     #width(width = .5) |>   -->
<!--     width(j = 2:17, width = .33) |>  -->
<!--     align(align = "center", part = "header") -->

<!-- ``` -->

# Onshore developments

Onshore developments (processing plants, support facilities etc.).

# Future prospects of the fishery

Future prospects of the fishery (long-term viability, expansion/contraction, etc.).

# Status of tuna fishery data collection systems

a.  Logsheet data collection and verification

b.  Observer programme

c.  Port sampling programme

d.  Unloading/Transhipment

e.  Other

# Research activities covering target and non-target species

For example, biological studies supporting stock assessments; composition of the catch according to length, weight and sex; research on environmental factors, abundance/biomass surveys, oceanographic and ecological studies, etc.


