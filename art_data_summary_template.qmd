---
title: "Generate Artisanal ACE"
author: "SPC - for UPDATE"
format: 
  html:
    page-layout: full
editor: visual
toc: true
toc-location: left
toccolor: blue
urlcolor: blue
embed-resources: true 
execute: 
  echo: false
  message: false
  warning: false
params:
  flag: 'VU'
  year: 2024
---

```{r}
# Load necessary libraries
library(DBI)
library(odbc)
library(tidyverse)
library(flextable)
#library(DT)
source("utils.R")

# Define the year
year <- params$year
member <- params$flag
this_yr_folder = paste0("./data/report_2024_", tolower(member), "/")

'%nin%' = function(x,y) !x %in% y            

```

::: panel-tabset
## Methodology

The steps for preparing the artisanal catch estimates for key tuna species are outlined below, with the following tabs showing the catch and effort estimates that are used to prepare the final catch estimates. It should be noted that the Tails (and moving forward, Ikasavea) app captures a sample of the artisanal fishing activity. At this point, we do not have comprehensive surveys in place to scale up those estimates in a reliable and representative manner. Therefore, we are basing these estimates on a combination of reporting catch and effort as well as local expert knowledge of the activities at different landing sites.

In the future, we hope to progress the Frame Survey concept to being to refine the estimates of total effort that are used to scale up the sampled catch estimates reported in the respective applications.

1.  We provide a summary of number of trips by month and landing site from the TAILS trip and activity logs
2.  We compare to "rough" estimates of average monthly landings (trips) per month and landing site \[used if activity log data is unreliable/incomplete\]
3.  The tuna catch by landings site and month is calculated
4.  We then multiply the monthly CPUE (catch/trip) by the estimated number of trips, and if those data are missing, we use an average CPUE multiplied by the number of trips
5.  The artisanal ACE is the sum across all months and landing sites

Please also note that until this point, Iksavea and Tails are separate applications collecting data in separate places. Therefore, please review the Iksavea data (SPC can provide) and the T2 report (#3095) for other species that may be have been reported to supplement this assessment of key tuna catches.

## Fishing Effort

### Data prep: Effort

Below is a summary of the number of reported **trips** in `r params$year` by month and landing site, as reported in Tails. This table compares both fishing days and trips reported (using the number of motor and paddle vessel trips reported), and takes the maximum value as an estimate of trips.

<details>

<summary>Reported Trips</summary>

```{r}
# Report 1
tab1 <- read_and_clean(this_yr_folder, member, r_code=3526)

```

```{r}
#| label: Monthly-effort
#| tbl-cap: Number of trips per month and landing site reported in Tails
if (ncol(tab1) > 0){
  flextable( tab1 ) |>  
  width(j=1, width=1.2) |> 
  fontsize(size = 10, part = "all")
}else
  cat("No data to show")

```

</details>

Read in member-estimated **trips** per month at each landing site. Some landing sites may not have any activity, that is OK. The member-provided estimates of effort by landing site and compared with the Tails reported effort to produce a 'best' estimate of effort.

<details>

<summary>Local Knowledge - Trips</summary>

```{r trips-est-mem}
#| label: mem-trips
#| tbl-cap: Member reported estimated trips per month per landing site

est.trips <- read_and_clean(this_yr_folder, member, r_code="estimated_trips", t2_dataset = FALSE)

if (ncol(est.trips) > 0){
  flextable(est.trips)  |>  fontsize(size = 10, part = "all") |> width(j=1, width=2)
}else
  cat("No data to show")

```

</details>

Below is a summary of the number of reported **days** in `r params$year` by month and landing site, as reported in Tails. This is used to estimate the number of trips per day.

<details>

<summary>Reported Days</summary>

```{r}
# Report 3

tab2 <- read_and_clean(this_yr_folder, member, r_code=3527)
  
```

```{r}
#| label: tab2
#| tbl-cap: Estimated fishing days reported in Tails
if (ncol(tab2) > 0){
  flextable(tab2 ) |>  fontsize(size = 10, part = "all")
}else
  cat("No data to show")
```

</details>

### Best estimate of fishing trips

Now estimate monthly trips, based on the max value either reported by the member or reported in Tails.

```{r max.trips}
#| label: est-trips-monthly
#| tbl-cap: Best estimate of trips per month at each landing site

if (ncol(tab1) > 0 && ncol(est.trips) > 0){

  # Formerly Table 8 in old Excel
  tab8 = tab1 |> full_join(est.trips)
  tab8[is.na(tab8)] <- 0
  
  for( i in 2:13){
    tab8[ ,i] = ifelse( tab8[ ,i] >  tab8[ ,14] ,  tab8[ ,i] , tab8[ ,14] )
  }
  
  # Get rid of sites that only have NAs
  tab8$num_na_cols <- rowSums(tab8[, 2:13] )
  
  tab8 <- tab8 |>  filter(num_na_cols>0) |>
    select(-c(est.trips, num_na_cols))
  
  # Now check for site with days but no trips -- just in case
  # TODO: add back this check!
  # tab8 <- tab8 |> 
  #   rbind(tab2 |>  filter(landing_site_name %nin% tab8$landing_site_name))
  
  flextable(tab8)  |>  fontsize(size = 8, part = "all")
}else{
  cat("No data to show")
  }

```

<!-- ### Step 1: Calculate trip/day -->

<!-- This step is ONLY useful if the ACTIVIY LOG is complete. -->

<!-- ```{r trips-day} -->

<!-- trips.day = tab1 |> gather(key='mon', value='trips', -c(1:2)) |> mutate(mon=substr(mon,1,3)) |>  -->

<!--   left_join(tab2 |> gather(key='mon', value='days', -1) |> mutate(mon=substr(mon,1,3))  ) |>  -->

<!--   mutate(trip.day = trips/days, trip.day = ifelse(is.na(trip.day),1,trip.day)) -->

<!-- ``` -->

## Catch Estimates

### Data prep: Catch

**Unraised** tuna catches reported in Tails are illustrated below, in kilograms (kgs).

<details>

<summary>Skipjack: SKJ</summary>

```{r report_4}
# Report 4
unr.catch <- read_and_clean(this_yr_folder, member, r_code=3529)

if (nrow(unr.catch) > 0) {
  names(unr.catch)[2:13]  <- c('jan', 'feb','mar','apr','may','jun',
                               'jul','aug','sep','oct','nov','dec')
        
  # TODO: this needs checking - compare with previous years!
  # Calculate total effort by landing site
  tab2$tot_trips =  rowSums(tab2[,-1],na.rm=T)
  tot.trips = tab2 |>  select(landing_site_name, tot_trips)
  
  # Now calculate monthly average catch per trip (using tab2)
  avg.skj = data.frame(landing_site_name = unr.catch$landing_site_name, 
                  tot_catch = rowSums(unr.catch[,-1],na.rm=T)  ) |> 
                left_join(tot.trips) |> 
    mutate(skj.cpd = round(tot_catch/tot_trips,0) )
  
  unr.catch <- unr.catch |> left_join(avg.skj |> select(landing_site_name, skj.cpd))
  unr.skj = unr.catch
}else{
 unr.skj = data.frame() 
}
  
```

```{r}
#| label: unr.skj
#| tbl-cap: Unraised skipjack catch (kgs) reported in Tails

if (ncol(unr.skj) > 0){
  flextable(unr.skj) |>  fontsize(size = 10, part = "all")
}else
  cat("No data to show")

```

</details>

<details>

<summary>Yellowfin: YFT</summary>

```{r}
# Unraised YFT catch

# Report 5
unr.yft <- read_and_clean(this_yr_folder, member, r_code=3530)
names(unr.yft)[2:13]  <- c('jan', 'feb','mar','apr','may','jun',
                             'jul','aug','sep','oct','nov','dec')
      

# Now calculate monthly average catch per trip (using tab2)
avg.yft = data.frame(landing_site_name = unr.yft$landing_site_name, 
                tot_catch = rowSums(unr.yft[,-1],na.rm=T)  ) |> 
              left_join(tot.trips) |> 
  mutate(yft.cpd = round(tot_catch/tot_trips,0) )

unr.yft <- unr.yft |> left_join(avg.yft |> select(landing_site_name, yft.cpd))
```

Unraised yellowfin catch (kgs) reported in Tails:

```{r unr.yft}

if (ncol(unr.yft) > 0){
  flextable(unr.yft) |>  fontsize(size = 10, part = "all")
}else
  cat("No data to show")

```

</details>

<details>

<summary>Bigeye: BET</summary>

```{r}
# Report 6

unr.bet <- read_and_clean(this_yr_folder, member, r_code=3531)
names(unr.bet)[2:13]  <- c('jan', 'feb','mar','apr','may','jun',
                             'jul','aug','sep','oct','nov','dec')

# Now calculate monthly average catch per trip (using tab2)
avg.bet = data.frame(landing_site_name = unr.bet$landing_site_name, 
                tot_catch = rowSums(unr.bet[,-1],na.rm=T)  ) |> 
              left_join(tot.trips) |> 
  mutate(bet.cpd = round(tot_catch/tot_trips,0) )

unr.bet <- unr.bet |> left_join(avg.bet |> select(landing_site_name, bet.cpd))
```

Unraised bigeye catch (kgs) reported in Tails:

```{r unr.bet}

if (ncol(unr.bet) > 0){
  flextable(unr.bet) |>  fontsize(size = 10, part = "all")
}else
  cat("No data to show")

```

</details>

**Raised** catches are produced using the average catch per trip, raised by the best estimate of trips, to produce a representative estimate of total artisanal tuna catches. It should be **noted** that is there are sites with no catches reported, these are removed from the totals, even if effort was indicated by the member. This should be revisited - and an error message is noted in this document when that occurs.

<details>

<summary>Skipjack: SKJ</summary>

Raised catch estimates for skipjack tuna (kg) in `r params$year`:

```{r raise-skj}

# Only generating raised estimates where catch was reported

if (ncol(unr.skj) > 0 && ncol(tab8) > 0){

  rs.skj <- unr.skj |>  select(1) |> rbind(tab8 |>  select(1)) |> distinct() |> data.frame()
  
  for(i in 2:13){
    tmp =
      data.frame(landing_site_name= rs.skj[,1]) |>
      left_join(unr.skj[,c(1,i,14)])  |>
      left_join(tab2[,c(1,i)]) |>
      left_join(tab8[,c(1,i)])
  
    tmp$raised = NA
    for(j in 1:nrow(tmp)){
    tmp[j,'raised'] =  round(ifelse(tmp[j,2]==0 & tmp[j,4]==0, tmp[j,'skj.cpd'], tmp[j,2]/tmp[j,4])*tmp[j,5])
    }
  
    tmp <- tmp[,c(1,6)]
    names(tmp)[2] <- paste(tolower(month.abb[i-1]),'skj','r',sep='_')
  
    rs.skj <- rs.skj |>  left_join(tmp)
  }
    # Remove rows where no catch was reported - as no average exists...
    rs.skj$no_catch <- rowSums(rs.skj[, 2:13],na.rm=T )
  
    missing.skj = rs.skj |>  filter(no_catch==0)
    rs.skj <- rs.skj |>  filter(no_catch>0) |>  select(-no_catch)
    
    flextable(rs.skj) |> colformat_num(j = 2:13, digits = 0) |>  fontsize(size = 8, part = "all")
}else{
  cat("No data to show")
}

```

<details>

<summary>Missing skipjack catch with effort</summary>

```{r missing.skj}
# Rows with no catch but some estimated fishing effort
# 

if (ncol(missing.skj) > 0) {
  flextable(missing.skj) |> colformat_num(j = 2:13, digits = 0) |>  fontsize(size = 8, part = "all")
}else{
  cat("No data to show")
}
```

</details>

</details>

<details>

<summary>Yellowfin: YFT</summary>

Raised catch estimates for yellowfin tuna (kg) in `r params$year`:

```{r raise-yft}

# Only generating raised estimates where catch was reported

if (ncol(unr.yft) > 0 && ncol(tab8) > 0) {

  rs.yft <- unr.yft |>  select(1) |> rbind(tab8 |>  select(1)) |> distinct()
  
  for(i in 2:13){
    tmp = unr.yft[,c(1,i,14)]  |> left_join(tab2[,c(1,i)]) |>
      left_join(tab8[,c(1,i)])
  
    tmp$raised = NA
    for(j in 1:nrow(tmp)){
    tmp[j,'raised'] =  round(ifelse(tmp[j,2]==0 & tmp[j,4]==0, tmp[j,'yft.cpd'], tmp[j,2]/tmp[j,4])*tmp[j,5])
    }
  
    tmp <- tmp[,c(1,6)]
    names(tmp)[2] <- paste(tolower(month.abb[i-1]),'yft','r',sep='_')
  
    rs.yft <- rs.yft |>  left_join(tmp)
  }
  
    # Remove rows where no catch was reported - as no average exists...
    rs.yft$no_catch <- rowSums(rs.yft[, 2:13],na.rm=T )
  
    missing.yft = rs.yft |>  filter(no_catch==0)
    rs.yft <- rs.yft |>  filter(no_catch>0) |>  select(-no_catch)
  
  flextable(rs.yft) |> colformat_num(j = 2:13, digits = 0) |>  fontsize(size = 8, part = "all")
  }else{
    cat("No data to show")
    }
```

<details>

<summary>Missing yellowfin catch with effort</summary>

```{r missing.yft}
# Rows with no catch but some estimated fishing effort
if (ncol(missing.yft) > 0) {

  flextable(missing.yft) |> colformat_num(j = 2:13, digits = 0) |>  fontsize(size = 8, part = "all")
  }else{
  cat("No data to show")
  }
# TODO: I stopped here, the code below needs review!
```

</details>

</details>

<details>

<summary>Bigeye: BET</summary>

Raised catch estimates for bigeye tuna (kg) in `r params$year`:

```{r raise-bet}

# Only generating raised estimates where catch was reported
rs.bet <- unr.bet |>  select(1) |> rbind(tab8 |>  select(1)) |> distinct()

if(nrow(unr.bet>0)){
for(i in 2:13){
  tmp = unr.bet[,c(1,i,14)]  |> left_join(tab2[,c(1,i)]) |>
    left_join(tab8[,c(1,i)])

  tmp$raised = NA
  for(j in 1:nrow(tmp)){
  tmp[j,'raised'] =  round(ifelse(tmp[j,2]==0 & tmp[j,4]==0, tmp[j,'bet.cpd'], tmp[j,2]/tmp[j,4])*tmp[j,5])
  }

  tmp <- tmp[,c(1,6)]
  names(tmp)[2] <- paste(tolower(month.abb[i-1]),'bet','r',sep='_')

  rs.bet <- rs.bet |>  left_join(tmp)
}

  # Remove rows where no catch was reported - as no average exists...
  rs.bet$no_catch <- rowSums(rs.bet[, 2:13],na.rm=T )

  missing.bet = rs.bet |>  filter(no_catch==0)
  rs.bet <- rs.bet |>  filter(no_catch>0) |>  select(-no_catch)

flextable(rs.bet) |> colformat_num(j = 2:13, digits = 0) |>  fontsize(size = 8, part = "all")

}
```

<details>

<summary>Missing bigeye catch with effort</summary>

```{r missing.bet}
# Rows with no catch but some estimated fishing effort
if(exists('missing.bet')){
  flextable(missing.bet) |> colformat_num(j = 2:13, digits = 0) |>  fontsize(size = 8, part = "all")
}
```

</details>

</details>

## Final Estimates

Here we take the raised catch estimates for the three key tuna species and sum them across all landing sites and months to produce an annual estimate in metric tonnes (mt).

```{r final.ace}
#| label: raised.ace
#| tbl-cap: Raised and unraised annual artisanal catch estimates in mt


unr.tmp = unr.skj |>  ungroup() |> select(-c(1,14)) |> summarise_all(sum, na.rm=T)
rs.tmp = rs.skj |> ungroup() |> select(-1)  |> summarise_all(sum, na.rm=T)
skj.art.ace = data.frame(
  sp = 'SKJ',
  unraised = round(rowSums(unr.tmp)/1000,2),
  raised = round(rowSums(rs.tmp)/1000,2)
)

unr.tmp = unr.yft |> ungroup() |> select(-c(1,14))  |> summarise_all(sum, na.rm=T)
rs.tmp = rs.yft |> ungroup() |> select(-1)  |> summarise_all(sum, na.rm=T)
yft.art.ace = data.frame(
  sp = 'YFT',
  unraised = round(rowSums(unr.tmp)/1000,2),
  raised = round(rowSums(rs.tmp)/1000,2)
)

if(exists("unr.bet")){
unr.tmp = unr.bet |> ungroup() |> select(-c(1,14)) |> summarise_all(sum, na.rm=T)
rs.tmp = rs.bet |> ungroup() |> select(-1)  |> summarise_all(sum, na.rm=T)

bet.art.ace = data.frame(
  sp = 'BET',
  unraised = round(rowSums(unr.tmp)/1000,2),
  raised = round(rowSums(rs.tmp)/1000,2)
)
}

# Produce final output

ace = rbind(skj.art.ace, yft.art.ace, bet.art.ace) |>
  gather(key='Method', value='ACE', -1) |>
  spread(key = sp, value=ACE)

flextable(ace) |>  fontsize(size = 12, part = "all")

```

```{r perc.sp}
#| label: ace.perc
#| tbl-cap: Percentage of the artisanal tuna ACE associated with each of the key species


ace$tot = rowSums(ace[,-1])
ace <- ace |>  mutate(SKJ = round(SKJ/tot*100,2),
                      YFT = round(YFT/tot*100,2),
                      BET = round(BET/tot*100,2)) |>
                select(-tot)

flextable(ace)  |>  fontsize(size = 12, part = "all")


```
:::
